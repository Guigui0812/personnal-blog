<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Le monitoring avec Prometheus et Grafana | grohee</title>
<meta name="keywords" content="">
<meta name="description" content="Prometheus est un outil open-source de surveillance et de gestion des métriques conçu pour collecter, stocker et analyser des données en temps réel. Il est particulièrement populaire dans les environnements cloud et DevOps grâce à son intégration facile avec des systèmes modernes comme Kubernetes.
Afin de visualiser les métriques collectées par prometheus, on utilise souvent Grafana qui permet de créer des tableaux de bord personnalisés.
Caractéristiques et fonctionnalités
Collecte de métriques
Prometheus fonctionne en mode pull. Il extrait des métriques en interrogeant des points d&rsquo;exposition (endpoints HTTP) appelés exporters. Ces derniers peuvent exposer des métriques d&rsquo;applications, systèmes, conteneurs, etc.">
<meta name="author" content="">
<link rel="canonical" href="http://localhost:1313/posts/prometheus/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.45e028aa8ce0961349adf411b013ee39406be2c0bc80d4ea3fc04555f7f4611a.css" integrity="sha256-ReAoqozglhNJrfQRsBPuOUBr4sC8gNTqP8BFVff0YRo=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/prometheus/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
</noscript>
</head>

<body class=" dark" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="grohee (Alt + H)">grohee</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/categories/" title="Catégories">
                    <span>Catégories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Le monitoring avec Prometheus et Grafana
    </h1>
    <div class="post-meta"><span title='2024-12-28 00:00:00 +0100 CET'>December 28, 2024</span>&nbsp;·&nbsp;572 words

</div>
  </header> 
  <div class="post-content"><p><strong>Prometheus</strong> est un outil open-source de surveillance et de gestion des métriques conçu pour collecter, stocker et analyser des données en temps réel. Il est particulièrement populaire dans les environnements cloud et DevOps grâce à son intégration facile avec des systèmes modernes comme Kubernetes.</p>
<p>Afin de visualiser les <strong>métriques</strong> collectées par <code>prometheus</code>, on utilise souvent <strong>Grafana</strong> qui permet de créer des tableaux de bord personnalisés.</p>
<h2 id="caractéristiques-et-fonctionnalités">Caractéristiques et fonctionnalités<a hidden class="anchor" aria-hidden="true" href="#caractéristiques-et-fonctionnalités">#</a></h2>
<h3 id="collecte-de-métriques">Collecte de métriques<a hidden class="anchor" aria-hidden="true" href="#collecte-de-métriques">#</a></h3>
<p><code>Prometheus</code> fonctionne en mode <code>pull</code>. Il extrait des métriques en interrogeant des points d&rsquo;exposition (<code>endpoints HTTP</code>) appelés <code>exporters</code>. Ces derniers peuvent exposer des métriques d&rsquo;applications, systèmes, conteneurs, etc.</p>
<p>Les données sont recueillies dans un format de type <strong>clé-valeur</strong> :</p>
<pre tabindex="0"><code class="language-prometheus" data-lang="prometheus">cpu_usage{host=&#34;server1&#34;} 0.45
</code></pre><p>Selon sa configuration, <code>prometheus</code> va collecter les métriques exposées à interval régulier.</p>
<h3 id="stockage">Stockage<a hidden class="anchor" aria-hidden="true" href="#stockage">#</a></h3>
<p>Les métriques sont stockées dans une <strong>tsdb</strong> (<em>Time series database</em>) qui permet de stocker temporelles au format <strong>clé / valeur</strong>.</p>
<p><code>Prometheus</code> embarque sa propre base de données <code>TSDB</code>, mais il est possible d&rsquo;utiliser d&rsquo;autres bases de données comme <code>InfluxDB</code> ou <code>OpenTSDB</code>.</p>
<h3 id="interroger-les-données">Interroger les données<a hidden class="anchor" aria-hidden="true" href="#interroger-les-données">#</a></h3>
<p>Pour cela on utilise le langage de requête de <code>prometheus</code> qui est <code>PromQL</code>. Il permet de créer des requêtes pour analyser les données collectées.</p>
<p>C&rsquo;est grâc à ce langage qu&rsquo;il est possible créer des graphiques, des alertes et des tableaux de bord dans <code>Grafana</code>.</p>
<h3 id="alerting">Alerting<a hidden class="anchor" aria-hidden="true" href="#alerting">#</a></h3>
<p><code>Prometheus</code> permet de définir des alertes basées sur les données collectées, grâce à son composant <code>Alertmanager</code>. Ces alertes peuvent être envoyées par mail par exemple.</p>
<h2 id="installation-et-configuration">Installation et configuration<a hidden class="anchor" aria-hidden="true" href="#installation-et-configuration">#</a></h2>
<p>Il est possible de mettre en place <code>prometheus</code> et <code>grafana</code> via leurs images <code>docker</code>.</p>
<h3 id="création-des-conteneurs">Création des conteneurs<a hidden class="anchor" aria-hidden="true" href="#création-des-conteneurs">#</a></h3>
<p><code>docker compose</code> est le choix privilégié ici en raison de sa facilité d&rsquo;utilisation et de sa lisibilité :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"></code></pre></div><h3 id="configuration-de-prometheus">Configuration de Prometheus<a hidden class="anchor" aria-hidden="true" href="#configuration-de-prometheus">#</a></h3>
<p>La configuration de <code>prometheus</code> se fait habituellement via le fichier <code>prometheus.yml</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">global</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">scrape_interval</span>: <span style="color:#ae81ff">15s </span> <span style="color:#75715e"># Fréquence de collecte des métriques</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">scrape_configs</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;prometheus&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">targets</span>: [<span style="color:#e6db74">&#39;localhost:9090&#39;</span>]
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">job_name</span>: <span style="color:#e6db74">&#39;node_exporter&#39;</span> <span style="color:#75715e"># On peut ajouter des exporters pour scrapper + de métriques</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">static_configs</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">targets</span>: [<span style="color:#e6db74">&#39;[target_ip]:9100&#39;</span>]  
</span></span></code></pre></div><p><strong>Quelques explications</strong> :</p>
<ul>
<li><code>global</code> : contient les paramètres globaux de <code>prometheus</code>.</li>
<li><code>scrape_interval</code> : fréquence de collecte des métriques.</li>
<li><code>scrape_configs</code> : contient les configurations des <code>jobs</code> qui sont les cibles de <code>prometheus</code>.</li>
<li><code>job_name</code> : nom du job de collecte.</li>
<li><code>static_configs</code> : contient les cibles à scrapper.</li>
</ul>
<p>Les différents éléments sont évidemment visibles sur l&rsquo;interface graphique mise à disposition par <code>prometheus</code>.</p>
<h2 id="configurer-des-exporters">Configurer des exporters<a hidden class="anchor" aria-hidden="true" href="#configurer-des-exporters">#</a></h2>
<p>Comme indiqué précédemment, <code>prometheus</code> scrape les <code>targets</code> définies dans le fichier de configuration. Ces <code>targets</code> sont souvent des <code>exporters</code> qui exposent des métriques : <code>node_exporter</code>, <code>docker_exporter</code>, etc.</p>
<h3 id="le-node-exporter">Le node exporter<a hidden class="anchor" aria-hidden="true" href="#le-node-exporter">#</a></h3>
<p>Cet <code>exporter</code> expose une grande variété de métriques du système : <code>cpu</code>, <code>ram</code>&hellip;</p>
<p>Afin de le configurer, il faut le télécharger depuis le  <a href="https://github.com/prometheus/node_exporter">dépôt git</a> en fonction la <strong>version</strong> et de l&rsquo;architecture <strong>CPU</strong> sur laquelle on souhaite l&rsquo;exécuter (armv7, amd64, etc.).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>wget https://github.com/prometheus/node_exporter/releases/download/v1.8.2/node_exporter-1.8.2.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>tar xvfz node_exporter-1.8.2.linux-amd64.tar.gz
</span></span><span style="display:flex;"><span>cd node_exporter-1.8.2.linux-amd64
</span></span><span style="display:flex;"><span>./node_exporter
</span></span></code></pre></div><p><strong>Remarque</strong> : Automatiser l&rsquo;installation des <strong>exporters</strong> est possible via Ansible ou tout autre outil de <strong>gestion de configurations</strong>.</p>
<p>Il faut ensuite configurer cet <code>exporter</code> en tant que service sur la machine.</p>
<p>Ainsi, sous <code>/etc/systemd/system/</code> on va créer un service <code>node_exporter.service</code> :</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>Unit<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>Description<span style="color:#f92672">=</span>Node Exporter
</span></span><span style="display:flex;"><span>Wants<span style="color:#f92672">=</span>network-online.target
</span></span><span style="display:flex;"><span>After<span style="color:#f92672">=</span>network-online.target
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Service<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>User<span style="color:#f92672">=</span>node_exporter
</span></span><span style="display:flex;"><span>Group<span style="color:#f92672">=</span>node_exporter
</span></span><span style="display:flex;"><span>Type<span style="color:#f92672">=</span>simple
</span></span><span style="display:flex;"><span>ExecStart<span style="color:#f92672">=</span>/etc/prometheus-exporters/node_exporter-1.8.2.linux-armv7/node_exporter --web.listen-address<span style="color:#f92672">=</span>:9100
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[</span>Install<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>WantedBy<span style="color:#f92672">=</span>multi-user.target
</span></span></code></pre></div><p>Il faut évidemment avoir créée un <code>user</code> dédié au service. Il est important de <strong>ne pas exécuter les exporters en tant que root</strong>.</p>
<h2 id="références">Références<a hidden class="anchor" aria-hidden="true" href="#références">#</a></h2>
<ul>
<li><a href="https://prometheus.io/docs/guides/node-exporter/">Documentation</a></li>
<li><a href="https://github.com/prometheus/node_exporter">Dépôt git</a></li>
<li><a href="https://www.digitalocean.com/community/tutorials/how-to-install-prometheus-on-ubuntu-16-04">How To Install Prometheus on Ubuntu 16.04 - Digital Ocean</a></li>
<li><a href="https://linuxhit.com/prometheus-node-exporter-on-raspberry-pi-how-to-install/">Prometheus node exporter on Raspberry Pi – How to install</a></li>
<li>
<ul>
<li><a href="https://blog.stephane-robert.info/docs/observer/metriques/prometheus/">Prometheus - Stephane Robert</a></li>
</ul>
</li>
</ul>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/">grohee</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
