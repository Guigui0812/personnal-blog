<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Proxmox : Automatiser le d√©ploiement de VM avec Cloud-Init et Terraform | grohee</title>
<meta name=keywords content><meta name=description content="D√©ployer des machines virtuelles sur un hyperviseur tel que Proxmox est une t√¢che fr√©quente pour tout administrateur syst√®me. Que ce soit dans un contexte de production ou dans un homelab, il s&rsquo;agit d&rsquo;une t√¢che r√©currente. L&rsquo;automatisation √©tant d√©sormais au coeur des m√©tiers de l&rsquo;infrastructure, c&rsquo;est exactement ce type de t√¢che qu&rsquo;il convient de repenser sous le prisme de l&rsquo;infrastructure as code via des outils modernes tels que Terraform et Cloud-Init."><meta name=author content><link rel=canonical href=https://guillaume-rohee.fr/posts/proxmox-cloudinit-terraform/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://guillaume-rohee.fr/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://guillaume-rohee.fr/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://guillaume-rohee.fr/favicon-32x32.png><link rel=apple-touch-icon href=https://guillaume-rohee.fr/apple-touch-icon.png><link rel=mask-icon href=https://guillaume-rohee.fr/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://guillaume-rohee.fr/posts/proxmox-cloudinit-terraform/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://guillaume-rohee.fr/posts/proxmox-cloudinit-terraform/"><meta property="og:site_name" content="grohee"><meta property="og:title" content="Proxmox : Automatiser le d√©ploiement de VM avec Cloud-Init et Terraform"><meta property="og:description" content="D√©ployer des machines virtuelles sur un hyperviseur tel que Proxmox est une t√¢che fr√©quente pour tout administrateur syst√®me. Que ce soit dans un contexte de production ou dans un homelab, il s‚Äôagit d‚Äôune t√¢che r√©currente. L‚Äôautomatisation √©tant d√©sormais au coeur des m√©tiers de l‚Äôinfrastructure, c‚Äôest exactement ce type de t√¢che qu‚Äôil convient de repenser sous le prisme de l‚Äôinfrastructure as code via des outils modernes tels que Terraform et Cloud-Init."><meta property="og:locale" content="fr"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-08-23T20:00:00+01:00"><meta property="article:modified_time" content="2025-08-23T20:00:00+01:00"><meta property="og:image" content="https://guillaume-rohee.fr/images/proxmox-terraform-cloudinit.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://guillaume-rohee.fr/images/proxmox-terraform-cloudinit.png"><meta name=twitter:title content="Proxmox : Automatiser le d√©ploiement de VM avec Cloud-Init et Terraform"><meta name=twitter:description content="D√©ployer des machines virtuelles sur un hyperviseur tel que Proxmox est une t√¢che fr√©quente pour tout administrateur syst√®me. Que ce soit dans un contexte de production ou dans un homelab, il s&rsquo;agit d&rsquo;une t√¢che r√©currente. L&rsquo;automatisation √©tant d√©sormais au coeur des m√©tiers de l&rsquo;infrastructure, c&rsquo;est exactement ce type de t√¢che qu&rsquo;il convient de repenser sous le prisme de l&rsquo;infrastructure as code via des outils modernes tels que Terraform et Cloud-Init."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://guillaume-rohee.fr/posts/"},{"@type":"ListItem","position":2,"name":"Proxmox : Automatiser le d√©ploiement de VM avec Cloud-Init et Terraform","item":"https://guillaume-rohee.fr/posts/proxmox-cloudinit-terraform/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Proxmox : Automatiser le d√©ploiement de VM avec Cloud-Init et Terraform","name":"Proxmox : Automatiser le d√©ploiement de VM avec Cloud-Init et Terraform","description":"D√©ployer des machines virtuelles sur un hyperviseur tel que Proxmox est une t√¢che fr√©quente pour tout administrateur syst√®me. Que ce soit dans un contexte de production ou dans un homelab, il s\u0026rsquo;agit d\u0026rsquo;une t√¢che r√©currente. L\u0026rsquo;automatisation √©tant d√©sormais au coeur des m√©tiers de l\u0026rsquo;infrastructure, c\u0026rsquo;est exactement ce type de t√¢che qu\u0026rsquo;il convient de repenser sous le prisme de l\u0026rsquo;infrastructure as code via des outils modernes tels que Terraform et Cloud-Init.\n","keywords":[],"articleBody":"D√©ployer des machines virtuelles sur un hyperviseur tel que Proxmox est une t√¢che fr√©quente pour tout administrateur syst√®me. Que ce soit dans un contexte de production ou dans un homelab, il s‚Äôagit d‚Äôune t√¢che r√©currente. L‚Äôautomatisation √©tant d√©sormais au coeur des m√©tiers de l‚Äôinfrastructure, c‚Äôest exactement ce type de t√¢che qu‚Äôil convient de repenser sous le prisme de l‚Äôinfrastructure as code via des outils modernes tels que Terraform et Cloud-Init.\nContexte Dans mon homelab personnel, je suis tr√®s souvent amen√© √† mettre en place de nouvelles machines virtuelles sur mon hyperviseur Proxmox lorsque je souhaite faire des tests ou h√©berger un nouveau service. Cela peut vite devenir fastidieux puisque sans automatisation, je dois cr√©er manuellement une nouvelle machine √† chaque fois.\nD√®s lors, la solution est simple : automatiser la mise en place de nouvelles machines virtuelles sur l‚Äôhyperviseur pour pouvoir se concentrer sur les tests et le d√©ploiement des nouveaux services, sans passer par l‚Äô√©tape suppl√©mentaire de configuration d‚Äôun h√¥te suppl√©mentaire.\nPr√©parer Proxmox pour l‚Äôautomatisation Avant d‚Äôaller plus avant, il faut pr√©parer l‚Äôenvironnement Proxmox.\nActivation des snippets Dans Proxmox, les snippets sont des fichiers de configuration (YAML, scripts) stock√©s dans un datastore. Ils permettent d‚Äôautomatiser des actions au moment du provisionnement. C‚Äôest donc dans cet emplacement que seront stock√©s les fichiers Cloud-Init. Ces derniers contiendront la configuration des machines virtuelles d√©ploy√©es afin de disposer de serveurs ‚Äúcl√©s en main‚Äù, pr√™ts √† √™tre utilis√©s.\nL‚Äôactivation est √† effectuer en passant par les menus Datacenter, Storage puis local afin de finalement cocher le param√®tre Snippets.\nT√©l√©charger une image Cloud-Init Les distributions majeures maintiennent des images Cloud-init pr√™tes √† l‚Äôemploi, compatibles avec l‚Äôoutil du m√™me nom.\nQuelques exemples par distributions :\nUbuntu Debian (choisir une image generic) Fedora Choisissez une distribution, t√©l√©chargez l‚Äôimage de votre choix et importez-la dans le r√©pertoire ISO images de votre hyperviseur Proxmox.\nInitier le projet Terraform Pr√©requis : si Terraform n‚Äôest pas install√© sur votre machine, installez le en suivant la documentation.\nAfin d‚Äôint√©ragir avec l‚ÄôAPI de Proxmox via Terraform, il faut utiliser un provider. Il s‚Äôagit du plugin √† l‚Äôoutil d‚Äôint√©ragir avec des services ou plateformes cloud (Proxmox, AWS, GCP,‚Ä¶) en traduisant les fichiers de configuration HCL (Hashicorp Configuration Language) en appels API √† destination de ces plateformes.\nComme un grand nombre de services modernes, Proxmox expose une API permettant d‚Äôeffectuer la plupart des actions qui peuvent √™tre d√©clench√©es via l‚Äôinterface graphique. D√®s lors, diff√©rents provider ont √©t√© d√©velopp√©s par la communaut√© pour interagir avec cette plateforme.\nParmi ceux-ci, j‚Äôai choisi bpg/proxmox qui se d√©gage clairement du lot de par ses fonctionnalit√©s, sa documentation et la fr√©quence de ses mises √† jour. C‚Äôest donc celui-ci que j‚Äôai d√©cid√© d‚Äôutiliser dans le cadre de l‚Äôautomatisation de mon Homelab.\nAjouter le provider √† votre fichier provider.tf :\nterraform { required_providers { proxmox = { source = \"bpg/proxmox\" version = \"\" } } } Ajouter le ensuite le bloc de configuration de bpg/proxmox √† provider.tf :\nprovider \"proxmox\" { endpoint = \"https://10.0.0.2:8006/\" username = \"root@pam\" password = \"\" insecure = true # if self-signed TLS certificate is in use ssh { agent = true } } Enfin, il ne reste plus qu‚Äô√† initier votre projet avec terraform init, ce qui permettra d‚Äôinitialiser le projet Terraform : cr√©ation du fichier tfstate, t√©l√©chargement des providers, etc.\nPour √©viter de stocker des secrets tels que le mot de passage Proxmox dans le code Terraform, il est possible de passer par une variable sensible :\nvariable \"proxmox_password\" { description = \"The password to connect to the Proxmox API\" type = string sensitive = true } Il faut ensuite utiliser cette variable comme valeur du param√®tre password dans le provider :\nprovider \"proxmox\" { endpoint = \"https://10.0.0.2:8006/\" username = \"root@pam\" password = var.proxmox_password insecure = true # if self-signed TLS certificate is in use ssh { agent = true } } Avant d‚Äôeffectuer les √©tapes plan et apply, il faudra cr√©er la variable d‚Äôenvironnement TF_VAR_proxmox_password :\nexport TF_VAR_proxmox_password= echo $TF_VAR_proxmox_password # v√©rification Terraform r√©cup√©rant l‚Äôensemble des variables d‚Äôenvironnement pr√©fix√©es par TF_VAR, la valeur du param√®tre sera celle d√©finie dans la variable.\nLe lien entre l‚Äôoutil IaC et l‚Äôhyperviseur √©tant maintenant op√©rationnel, il est temps de passer √† l‚Äô√©tape de cr√©ation d‚Äôune machine virtuelle.\nCr√©ation d‚Äôune machines virtuelle proxmox avec Terraform Le d√©ploiement d‚Äôun serveur simple, sans configuration personnalis√©e, s‚Äôav√®re rapide avec Terraform et bpg/proxmox.\nDans un premier temps, il suffit de cr√©er un fichier main.tf (ou autre nom de votre choix) et d‚Äôy ajouter le code permettant de cr√©er une machinne virtuelle :\ndata \"local_file\" \"ssh_public_key\" { filename = \"./id_rsa.pub\" } resource \"proxmox_virtual_environment_vm\" \"ubuntu_vm\" { name = \"example-ubuntu\" node_name = \"pve\" # Doit correspondre au nom de votre hyperviseur initialization { ip_config { ipv4 { address = \"/\" gateway = \"\" } } user_account { username = \"\" keys = [trimspace(data.local_file.ssh_public_key.content)] } } disk { datastore_id = \"local-lvm\" file_id = proxmox_virtual_environment_download_file.ubuntu_cloud_image.id interface = \"virtio0\" iothread = true discard = \"on\" size = 30 } network_device { bridge = \"vmbr0\" } } # T√©l√©chargement automatis√© de l'ISO, sans action manuelle resource \"proxmox_virtual_environment_download_file\" \"ubuntu_cloud_image\" { content_type = \"iso\" datastore_id = \"local\" node_name = \"pve\" # Doit correspondre au nom de votre hyperviseur url = \"\" } Remarque : le fichier ./id_rsa.pub (cl√© publique) doit √™tre pr√©sent dans votre projet Terraform.\nPour d√©ployer le nouveau serveur, il suffit de suivre les √©tapes classiques d‚Äôun d√©ploiement Terraform:\nEffectuer le plan afin de v√©rifier les changements apport√©s √† l‚Äôinfrastructure : terraform plan -out .plan Appliquer les changements : terraform apply .plan Apr√®s quelques instants, la nouvelle machine virtuelle devrait √™tre d√©ploy√©e et en fonctionnement sur l‚Äôhyperviseur.\nRemarque : Si vous souhaitez d√©truire le serveur, √©vitez les actions manuelles car cela pourrait cr√©er une inconsistance dans votre fichier tfstate. Effectuez plut√¥t la destruction via terraform destroy une fois le code de votre VM comment√© ou en utilisant l‚Äôoption -target.\nCr√©er une VM avec configuration personnalis√©e Exemple de d√©ploiement avec Terraform et Cloud Init Bien qu‚Äôautomatiser le d√©ploiement d‚Äôune VM sur Proxmox permette un l√©ger gain de temps, ce n‚Äôest pas suffisant pour parler d‚Äôautomatisation. Les √©tapes post√©rieures au d√©ploiement comme la configuration d‚Äôutilisateurs ou l‚Äôinstallation de paquets restent √† √™tre effectu√©es.\nHeureusement, bpg/proxmox permet d‚Äôexploiter la capacit√© de Proxmox d‚Äôutiliser des templates de configuration Cloud Init pour appliquer des configurations personnalis√©es aux VMs utilisant des images cloud (impossible avec des images standards).\nCloud Init est un outil permettant de d√©finir la configuration de machines virtuelles lors de leur premier d√©marrage. Via un fichier de configuration au format YAML, l‚Äôadministrateur va pouvoir cr√©er des utilisateurs, installer des paquets, personnaliser des √©l√©ments du serveur et m√™me ex√©cuter des scripts. C‚Äôest donc un outil tr√®s utile pour d√©ployer des serveurs pr√™ts √† l‚Äôemploi de mani√®re standardis√©e.\nLa cr√©ation d‚Äôune VM utilisant Cloud Init avec Terraform peut √™tre effectu√©e √† l‚Äôaide de l‚Äôexemple suivant :\nresource \"proxmox_virtual_environment_file\" \"example-ubuntu-cloud-config\" { content_type = \"snippets\" datastore_id = \"local\" node_name = \"pve\" source_raw { data = \u003c\u003c-EOF #cloud-config hostname: example-ubuntu timezone: Europe/Paris users: - default - name: \u003cusername\u003e sudo: ALL=(ALL) NOPASSWD:ALL shell: /bin/bash groups: - sudo expire: False ssh_pwauth: true runcmd: - echo \"MOTD_CONTENT\" \u003e /etc/motd package_update: true packages: - qemu-guest-agent - net-tools - curl runcmd: - systemctl enable qemu-guest-agent - systemctl start qemu-guest-agent EOF file_name = \"example-ubuntu-cloud-config.yaml\" } } resource \"proxmox_virtual_environment_vm\" \"example-ubuntu\" { name = \"example-ubuntu\" # Doit √™tre le m√™me √† celui d√©fini dans la configuration cloud-init node_name = \"pve\" cpu { cores = \"2\" } memory { dedicated = \"2048\" } initialization { user_account { username = \"\" password = var.proxmox_password } ip_config { ipv4 { address = \"/\" gateway = \"\" } } user_data_file_id = proxmox_virtual_environment_file.example-ubuntu-cloud-config.id } disk { datastore_id = \"local-lvm\" file_id = \"local:iso/.img\" # Convertir l'image au format img si n√©cessaire interface = \"virtio0\" iothread = \"true\" discard = \"on\" size = \"30\" } network_device { bridge = \"vmbr0\" } } Le d√©ploiement de cette VM s‚Äôeffectue de la m√™me mani√®re que pr√©c√©demment en suivant les √©tapes de plan et apply. Apr√®s quelques instants, une nouvelle machine virtuelle sera d√©ploy√©e avec l‚Äôensemble des configurations correspondant √† celles d√©finies dans le bloc d√©di√© √† Cloud Init. De nombreuses autres directives sont d‚Äôailleurs disponibles pour pousser la personnalisation.\nZoom sur Cloud Init Cloud Init propose un grand nombre de directives pour personnaliser diff√©rents aspects des d√©ploiements.\nPaquets Parfait üëç Tu peux faire une section ‚ÄúZoom sur Cloud-Init‚Äù bien d√©coup√©e par th√©matique. Voici une version pr√™te √† int√©grer dans ton article, avec des exemples r√©alistes et comment√©s :\nZoom sur Cloud-Init Cloud-Init propose un grand nombre de directives pour personnaliser diff√©rents aspects des d√©ploiements. L‚Äôensemble des directive est d√©taill√©e dans la documentation de Cloud Init.\nPaquets Installer automatiquement des paquets au premier boot :\n#cloud-config packages: - vim - htop - curl - git L‚Äôinstallation des guest-agents est d‚Äôailleurs fortement recommand√©e sur vos VMs :\n#cloud-config packages: - qemu-guest-agent runcmd: - systemctl enable qemu-guest-agent - systemctl start qemu-guest-agent R√©seau Configurer une interface r√©seau avec une IP statique :\n#cloud-config network: version: 2 ethernets: ens18: dhcp4: no addresses: - 192.168.1.50/24 gateway4: 192.168.1.1 nameservers: addresses: [192.168.1.1, 8.8.8.8] Configurer les dnsvia resolv.conf :\n#cloud-config manage_resolv_conf: true resolv_conf: domain: example.com nameservers: [8.8.8.8, 8.8.4.4] options: {rotate: true, timeout: 1} searchdomains: [foo.example.com, bar.example.com] sortlist: [10.0.0.1/255, 10.0.0.2] Utilisateurs D√©finir des utilisateurs suppl√©mentaires avec sudo et cl√©s SSH :\n#cloud-config users: - name: username groups: sudo shell: /bin/bash sudo: ALL=(ALL) NOPASSWD:ALL ssh_authorized_keys: - plain_text_passwd: Commandes √† l‚Äôinitialisation Lancer des commandes apr√®s le boot :\n#cloud-config runcmd: - echo \"Server Initialised\" \u003e init.log Gestion des mots de passe D√©finir un mot de passe pour un utilisateur et activer l‚Äôauthentification SSH par mot de passe (optionnel) :\n#cloud-config chpasswd: list: | username:motdepasse expire: False ssh_pwauth: true Mise √† jour et upgrade syst√®me Forcer la mise √† jour du syst√®me lors du premier boot :\n#cloud-config package_update: true package_upgrade: true Standardisation des d√©ploiement via un module d√©di√© L‚Äôutilisation de Terraform pour d√©ployer des machines virtuelles dans Proxmox m‚Äôa apport√© fluidit√© et facilit√© d‚Äôutilisation lors de la mise en place de nouveaux services dans mon Homelab. Cependant, si dans un premier temps j‚Äôeffectuais une copie de mes configurations pour cr√©er un nouveau serveur, j‚Äôai rapidement pr√©f√©r√© cr√©er un module Terraform afin de standardiser mes d√©ploiements et de disposer d‚Äôun bloc de code r√©utilisable afin d‚Äô√©viter ces √©tapes fastidieuses.\nCe module est d‚Äôailleurs disponible publiquement sur github afin d‚Äôaider des personnes qui souhaiteraient d√©ployer facilement des VMs dans leur mon homelab personnel.\nConclusion Cette approche permet de d√©ployer rapidement des VMs pr√™tes √† l‚Äôemploi. L‚Äô√©tape suivante, dans mon cas, a √©t√© d‚Äôint√©grer Ansible pour configurer automatiquement les services au-dessus des VMs. Cela permet de pousser l‚Äôautomatisation encore plus loin, dans une logique compl√®te d‚ÄôInfrastructure as Code.\nR√©f√©rences Documentation de bpg/proxmox Proxmox : d√©ployer une machine virtuelle KVM avec cloud-init ‚Äì memo-linux.com Cr√©er des templates de machines virtuelles avec Cloud-Init Provisionner des VM avec Terraform - St√©phane Roberts Terraform Apply - When to Run \u0026 Quick Usage Examples Instancier une machine virtuelle Debian dans Proxmox avec OpenTofu et¬†Cloud-Init cloud-init 25.1 documentation ","wordCount":"1825","inLanguage":"en","image":"https://guillaume-rohee.fr/images/proxmox-terraform-cloudinit.png","datePublished":"2025-08-23T20:00:00+01:00","dateModified":"2025-08-23T20:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://guillaume-rohee.fr/posts/proxmox-cloudinit-terraform/"},"publisher":{"@type":"Organization","name":"grohee","logo":{"@type":"ImageObject","url":"https://guillaume-rohee.fr/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://guillaume-rohee.fr/ accesskey=h title="grohee (Alt + H)">grohee</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://guillaume-rohee.fr/categories/ title=Cat√©gories><span>Cat√©gories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://guillaume-rohee.fr/>Home</a>&nbsp;¬ª&nbsp;<a href=https://guillaume-rohee.fr/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Proxmox : Automatiser le d√©ploiement de VM avec Cloud-Init et Terraform</h1><div class=post-meta><span title='2025-08-23 20:00:00 +0100 +0100'>August 23, 2025</span>&nbsp;¬∑&nbsp;1825 words</div></header><figure class=entry-cover><img loading=eager src=https://guillaume-rohee.fr/images/proxmox-terraform-cloudinit.png alt="Proxmox with terraform & cloudinit"><figcaption>Proxmox with terraform & cloudinit</figcaption></figure><div class=post-content><p>D√©ployer des machines virtuelles sur un hyperviseur tel que <code>Proxmox</code> est une t√¢che fr√©quente pour tout administrateur syst√®me. Que ce soit dans un contexte de production ou dans un homelab, il s&rsquo;agit d&rsquo;une t√¢che r√©currente. L&rsquo;automatisation √©tant d√©sormais au coeur des m√©tiers de l&rsquo;infrastructure, c&rsquo;est exactement ce type de t√¢che qu&rsquo;il convient de repenser sous le prisme de <strong>l&rsquo;infrastructure as code</strong> via des outils modernes tels que <code>Terraform</code> et <code>Cloud-Init</code>.</p><h2 id=contexte>Contexte<a hidden class=anchor aria-hidden=true href=#contexte>#</a></h2><p>Dans mon <strong>homelab personnel</strong>, je suis tr√®s souvent amen√© √† mettre en place de nouvelles machines virtuelles sur mon hyperviseur Proxmox lorsque je souhaite faire des tests ou h√©berger un nouveau service. Cela peut vite devenir fastidieux puisque sans automatisation, je dois cr√©er manuellement une nouvelle machine √† chaque fois.</p><p>D√®s lors, la solution est simple : <strong>automatiser la mise en place de nouvelles machines virtuelles sur l&rsquo;hyperviseur</strong> pour pouvoir se concentrer sur les tests et le d√©ploiement des nouveaux services, sans passer par l&rsquo;√©tape suppl√©mentaire de configuration d&rsquo;un h√¥te suppl√©mentaire.</p><h2 id=pr√©parer-proxmox-pour-lautomatisation>Pr√©parer Proxmox pour l&rsquo;automatisation<a hidden class=anchor aria-hidden=true href=#pr√©parer-proxmox-pour-lautomatisation>#</a></h2><p>Avant d&rsquo;aller plus avant, il faut pr√©parer l‚Äôenvironnement Proxmox.</p><h3 id=activation-des-snippets>Activation des snippets<a hidden class=anchor aria-hidden=true href=#activation-des-snippets>#</a></h3><p>Dans Proxmox, les <strong>snippets sont des fichiers de configuration</strong> (YAML, scripts) stock√©s dans un datastore. Ils permettent d‚Äôautomatiser des actions au moment du provisionnement. C&rsquo;est donc dans cet emplacement que seront stock√©s les fichiers <code>Cloud-Init</code>. Ces derniers <strong>contiendront la configuration des machines virtuelles d√©ploy√©es</strong> afin de disposer de serveurs &ldquo;cl√©s en main&rdquo;, pr√™ts √† √™tre utilis√©s.</p><p>L&rsquo;activation est √† effectuer en passant par les menus <code>Datacenter</code>, <code>Storage</code> puis <code>local</code> afin de finalement cocher le param√®tre <code>Snippets</code>.</p><h3 id=t√©l√©charger-une-image-cloud-init>T√©l√©charger une image Cloud-Init<a hidden class=anchor aria-hidden=true href=#t√©l√©charger-une-image-cloud-init>#</a></h3><p>Les distributions majeures maintiennent des images <code>Cloud-init</code> pr√™tes √† l‚Äôemploi, compatibles avec l&rsquo;outil du m√™me nom.</p><p>Quelques exemples par distributions :</p><ul><li><a href=https://cloud-images.ubuntu.com/>Ubuntu</a></li><li><a href=https://cloud.debian.org/images/cloud/>Debian</a> (choisir une image <code>generic</code>)</li><li><a href=https://fedoraproject.org/fr/cloud/download>Fedora</a></li></ul><p>Choisissez une distribution, t√©l√©chargez l&rsquo;image de votre choix et importez-la dans le r√©pertoire <code>ISO images</code> de votre hyperviseur <code>Proxmox</code>.</p><h2 id=initier-le-projet-terraform>Initier le projet Terraform<a hidden class=anchor aria-hidden=true href=#initier-le-projet-terraform>#</a></h2><p><strong>Pr√©requis</strong> : si <code>Terraform</code> n&rsquo;est pas install√© sur votre machine, installez le en suivant la <a href=https://developer.hashicorp.com/terraform/install>documentation</a>.</p><p>Afin d&rsquo;int√©ragir avec l&rsquo;API de <code>Proxmox</code> via <code>Terraform</code>, il faut utiliser un <code>provider</code>. Il s&rsquo;agit du plugin √† l&rsquo;outil d&rsquo;int√©ragir avec des services ou plateformes cloud (<code>Proxmox</code>, <code>AWS</code>, <code>GCP</code>,&mldr;) en traduisant les fichiers de configuration <code>HCL</code> (<em>Hashicorp Configuration Language</em>) en appels API √† destination de ces plateformes.</p><p>Comme un grand nombre de services modernes, <code>Proxmox</code> expose une <code>API</code> permettant d&rsquo;effectuer la plupart des actions qui peuvent √™tre d√©clench√©es via l&rsquo;interface graphique. D√®s lors, diff√©rents <code>provider</code> ont √©t√© d√©velopp√©s par la communaut√© pour interagir avec cette plateforme.</p><p>Parmi ceux-ci, j&rsquo;ai choisi <a href=https://registry.terraform.io/providers/bpg/proxmox/latest/docs>bpg/proxmox</a> qui se d√©gage clairement du lot de par ses fonctionnalit√©s, sa documentation et la fr√©quence de ses mises √† jour. C&rsquo;est donc celui-ci que j&rsquo;ai d√©cid√© d&rsquo;utiliser dans le cadre de l&rsquo;automatisation de mon <strong>Homelab</strong>.</p><p>Ajouter le <code>provider</code> √† votre fichier <code>provider.tf</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>terraform</span> {
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>required_providers</span> {
</span></span><span style=display:flex><span>    proxmox <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>      source  <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;bpg/proxmox&#34;</span>
</span></span><span style=display:flex><span>      version <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;version&gt;&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Ajouter le ensuite le bloc de configuration de <code>bpg/proxmox</code> √† <code>provider.tf</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;proxmox&#34;</span> {
</span></span><span style=display:flex><span>    endpoint <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://10.0.0.2:8006/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;root@pam&#34;</span>
</span></span><span style=display:flex><span>    password <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;proxmox_password&gt;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    insecure <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#75715e> # if self-signed TLS certificate is in use
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ssh</span> {
</span></span><span style=display:flex><span>        agent <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Enfin, il ne reste plus qu&rsquo;√† initier votre projet avec <code>terraform init</code>, ce qui permettra d&rsquo;initialiser le projet <code>Terraform</code> : cr√©ation du fichier <code>tfstate</code>, t√©l√©chargement des providers, etc.</p><p>Pour √©viter de stocker des secrets tels que le mot de passage <code>Proxmox</code> dans le code <code>Terraform</code>, il est possible de passer par une <strong>variable sensible</strong> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>variable</span> <span style=color:#e6db74>&#34;proxmox_password&#34;</span> {
</span></span><span style=display:flex><span>    description <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;The password to connect to the Proxmox API&#34;</span>
</span></span><span style=display:flex><span>    type        <span style=color:#f92672>=</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    sensitive   <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Il faut ensuite utiliser cette variable comme valeur du param√®tre <code>password</code> dans le <code>provider</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>provider</span> <span style=color:#e6db74>&#34;proxmox&#34;</span> {
</span></span><span style=display:flex><span>    endpoint <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;https://10.0.0.2:8006/&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;root@pam&#34;</span>
</span></span><span style=display:flex><span>    password <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>proxmox_password</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    insecure <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span><span style=color:#75715e> # if self-signed TLS certificate is in use
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ssh</span> {
</span></span><span style=display:flex><span>        agent <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Avant d&rsquo;effectuer les √©tapes <code>plan</code> et <code>apply</code>, il faudra cr√©er la variable d&rsquo;environnement <code>TF_VAR_proxmox_password</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>export TF_VAR_proxmox_password<span style=color:#f92672>=</span>&lt;password&gt;
</span></span><span style=display:flex><span>echo $TF_VAR_proxmox_password <span style=color:#75715e># v√©rification</span>
</span></span></code></pre></div><p><code>Terraform</code> r√©cup√©rant l&rsquo;ensemble des variables d&rsquo;environnement pr√©fix√©es par <code>TF_VAR</code>, la valeur du param√®tre sera celle d√©finie dans la variable.</p><p>Le lien entre l&rsquo;outil <code>IaC</code> et l&rsquo;hyperviseur √©tant maintenant op√©rationnel, il est temps de passer √† l&rsquo;√©tape de cr√©ation d&rsquo;une machine virtuelle.</p><h2 id=cr√©ation-dune-machines-virtuelle-proxmox-avec-terraform>Cr√©ation d&rsquo;une machines virtuelle proxmox avec Terraform<a hidden class=anchor aria-hidden=true href=#cr√©ation-dune-machines-virtuelle-proxmox-avec-terraform>#</a></h2><p>Le d√©ploiement d&rsquo;un serveur simple, sans configuration personnalis√©e, s&rsquo;av√®re rapide avec <code>Terraform</code> et <code>bpg/proxmox</code>.</p><p>Dans un premier temps, il suffit de cr√©er un fichier <code>main.tf</code> (ou autre nom de votre choix) et d&rsquo;y ajouter le code permettant de cr√©er une machinne virtuelle :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>data</span> <span style=color:#e6db74>&#34;local_file&#34; &#34;ssh_public_key&#34;</span> {
</span></span><span style=display:flex><span>  filename <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;./id_rsa.pub&#34;</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;proxmox_virtual_environment_vm&#34; &#34;ubuntu_vm&#34;</span> {
</span></span><span style=display:flex><span>  name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;example-ubuntu&#34;</span>
</span></span><span style=display:flex><span>  node_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pve&#34;</span><span style=color:#75715e> # Doit correspondre au nom de votre hyperviseur
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>initialization</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ip_config</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>ipv4</span> {
</span></span><span style=display:flex><span>        address <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;ip&gt;/&lt;cidr&gt;&#34;</span>
</span></span><span style=display:flex><span>        gateway <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;ip&gt;&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>user_account</span> {
</span></span><span style=display:flex><span>      username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;username&gt;&#34;</span>
</span></span><span style=display:flex><span>      keys     <span style=color:#f92672>=</span> [<span style=color:#66d9ef>trimspace</span>(<span style=color:#66d9ef>data</span>.<span style=color:#66d9ef>local_file</span>.<span style=color:#66d9ef>ssh_public_key</span>.<span style=color:#66d9ef>content</span>)]
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>disk</span> {
</span></span><span style=display:flex><span>    datastore_id <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;local-lvm&#34;</span>
</span></span><span style=display:flex><span>    file_id      <span style=color:#f92672>=</span> <span style=color:#66d9ef>proxmox_virtual_environment_download_file</span>.<span style=color:#66d9ef>ubuntu_cloud_image</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>    interface    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;virtio0&#34;</span>
</span></span><span style=display:flex><span>    iothread     <span style=color:#f92672>=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    discard      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;on&#34;</span>
</span></span><span style=display:flex><span>    size         <span style=color:#f92672>=</span> <span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>network_device</span> {
</span></span><span style=display:flex><span>    bridge <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vmbr0&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}<span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e># T√©l√©chargement automatis√© de l&#39;ISO, sans action manuelle
</span></span></span><span style=display:flex><span><span style=color:#75715e></span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;proxmox_virtual_environment_download_file&#34; &#34;ubuntu_cloud_image&#34;</span> {
</span></span><span style=display:flex><span>  content_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;iso&#34;</span>
</span></span><span style=display:flex><span>  datastore_id <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;local&#34;</span>
</span></span><span style=display:flex><span>  node_name    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pve&#34;</span><span style=color:#75715e> # Doit correspondre au nom de votre hyperviseur
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  url          <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;url_image_iso&gt;&#34;</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><strong>Remarque</strong> : le fichier <code>./id_rsa.pub</code> (cl√© publique) doit √™tre pr√©sent dans votre projet <code>Terraform</code>.</p><p>Pour d√©ployer le nouveau serveur, il suffit de suivre les √©tapes classiques d&rsquo;un d√©ploiement <code>Terraform</code>:</p><ul><li>Effectuer le <strong>plan</strong> afin de v√©rifier les changements apport√©s √† l&rsquo;infrastructure : <code>terraform plan -out &lt;fichier>.plan</code></li><li>Appliquer les changements : <code>terraform apply &lt;fichier>.plan</code></li></ul><p>Apr√®s quelques instants, la nouvelle machine virtuelle devrait √™tre d√©ploy√©e et en fonctionnement sur l&rsquo;hyperviseur.</p><p><strong>Remarque</strong> : Si vous souhaitez d√©truire le serveur, √©vitez les actions manuelles car cela pourrait cr√©er une inconsistance dans votre fichier <code>tfstate</code>. Effectuez plut√¥t la destruction via <code>terraform destroy</code> une fois le code de votre VM comment√© ou en utilisant l&rsquo;option <code>-target</code>.</p><h2 id=cr√©er-une-vm-avec-configuration-personnalis√©e>Cr√©er une VM avec configuration personnalis√©e<a hidden class=anchor aria-hidden=true href=#cr√©er-une-vm-avec-configuration-personnalis√©e>#</a></h2><h3 id=exemple-de-d√©ploiement-avec-terraform-et-cloud-init>Exemple de d√©ploiement avec Terraform et Cloud Init<a hidden class=anchor aria-hidden=true href=#exemple-de-d√©ploiement-avec-terraform-et-cloud-init>#</a></h3><p>Bien qu&rsquo;automatiser le d√©ploiement d&rsquo;une VM sur <code>Proxmox</code> permette un l√©ger gain de temps, ce n&rsquo;est pas suffisant pour parler d&rsquo;automatisation. Les √©tapes post√©rieures au d√©ploiement comme la configuration d&rsquo;utilisateurs ou l&rsquo;installation de paquets restent √† √™tre effectu√©es.</p><p>Heureusement, <code>bpg/proxmox</code> permet d&rsquo;exploiter la capacit√© de <code>Proxmox</code> d&rsquo;utiliser des templates de configuration <code>Cloud Init</code> pour appliquer des configurations personnalis√©es aux VMs utilisant des <strong>images cloud</strong> (impossible avec des images standards).</p><p><code>Cloud Init</code> est un <strong>outil permettant de d√©finir la configuration de machines virtuelles lors de leur premier d√©marrage</strong>. Via un fichier de configuration au format <code>YAML</code>, l&rsquo;administrateur va pouvoir cr√©er des utilisateurs, installer des paquets, personnaliser des √©l√©ments du serveur et m√™me ex√©cuter des scripts. C&rsquo;est donc un outil tr√®s <strong>utile pour d√©ployer des serveurs pr√™ts √† l&rsquo;emploi de mani√®re standardis√©e</strong>.</p><p>La cr√©ation d&rsquo;une VM utilisant <code>Cloud Init</code> avec <code>Terraform</code> peut √™tre effectu√©e √† l&rsquo;aide de l&rsquo;exemple suivant :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-hcl data-lang=hcl><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;proxmox_virtual_environment_file&#34; &#34;example-ubuntu-cloud-config&#34;</span> {
</span></span><span style=display:flex><span>    content_type <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;snippets&#34;</span>
</span></span><span style=display:flex><span>    datastore_id <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;local&#34;</span>
</span></span><span style=display:flex><span>    node_name    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pve&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>source_raw</span> {
</span></span><span style=display:flex><span>    data <span style=color:#f92672>=</span> <span style=color:#960050;background-color:#1e0010>&lt;&lt;-</span><span style=color:#66d9ef>EOF</span><span style=color:#75715e>
</span></span></span><span style=display:flex><span><span style=color:#75715e>    #cloud-config
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    <span style=color:#66d9ef>hostname</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>example</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>ubuntu</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>timezone</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>Europe</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>Paris</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>users</span><span style=color:#960050;background-color:#1e0010>:</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>-</span> <span style=color:#66d9ef>default</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>-</span> <span style=color:#66d9ef>name</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#960050;background-color:#1e0010>&lt;</span><span style=color:#66d9ef>username</span><span style=color:#960050;background-color:#1e0010>&gt;</span>
</span></span><span style=display:flex><span>          sudo: ALL<span style=color:#f92672>=</span>(<span style=color:#66d9ef>ALL</span>) <span style=color:#66d9ef>NOPASSWD</span><span style=color:#960050;background-color:#1e0010>:</span><span style=color:#66d9ef>ALL</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>shell</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>bin</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>bash</span>
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>groups</span><span style=color:#960050;background-color:#1e0010>:</span>
</span></span><span style=display:flex><span>            <span style=color:#960050;background-color:#1e0010>-</span> <span style=color:#66d9ef>sudo</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>expire</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ssh_pwauth</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>runcmd</span><span style=color:#960050;background-color:#1e0010>:</span>
</span></span><span style=display:flex><span>        <span style=color:#960050;background-color:#1e0010>-</span> <span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;MOTD_CONTENT&#34;</span> <span style=color:#960050;background-color:#1e0010>&gt;</span> <span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>etc</span><span style=color:#960050;background-color:#1e0010>/</span><span style=color:#66d9ef>motd</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>package_update</span><span style=color:#960050;background-color:#1e0010>:</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>packages</span><span style=color:#960050;background-color:#1e0010>:</span>
</span></span><span style=display:flex><span>      <span style=color:#960050;background-color:#1e0010>-</span> <span style=color:#66d9ef>qemu</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>guest</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>agent</span>
</span></span><span style=display:flex><span>      <span style=color:#960050;background-color:#1e0010>-</span> <span style=color:#66d9ef>net</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>tools</span>
</span></span><span style=display:flex><span>      <span style=color:#960050;background-color:#1e0010>-</span> <span style=color:#66d9ef>curl</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>runcmd</span><span style=color:#960050;background-color:#1e0010>:</span>
</span></span><span style=display:flex><span>      <span style=color:#960050;background-color:#1e0010>-</span> <span style=color:#66d9ef>systemctl</span> <span style=color:#66d9ef>enable</span> <span style=color:#66d9ef>qemu</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>guest</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>agent</span>
</span></span><span style=display:flex><span>      <span style=color:#960050;background-color:#1e0010>-</span> <span style=color:#66d9ef>systemctl</span> <span style=color:#66d9ef>start</span> <span style=color:#66d9ef>qemu</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>guest</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>agent</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>EOF</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    file_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;example-ubuntu-cloud-config.yaml&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>resource</span> <span style=color:#e6db74>&#34;proxmox_virtual_environment_vm&#34; &#34;example-ubuntu&#34;</span> {
</span></span><span style=display:flex><span>  name      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;example-ubuntu&#34;</span><span style=color:#75715e> # Doit √™tre le m√™me √† celui d√©fini dans la configuration cloud-init
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  node_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;pve&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>cpu</span> {
</span></span><span style=display:flex><span>    cores <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>memory</span> {
</span></span><span style=display:flex><span>    dedicated <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;2048&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>initialization</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>user_account</span> {
</span></span><span style=display:flex><span>      username <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;username&gt;&#34;</span>
</span></span><span style=display:flex><span>      password <span style=color:#f92672>=</span> <span style=color:#66d9ef>var</span>.<span style=color:#66d9ef>proxmox_password</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>ip_config</span> {
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>ipv4</span> {
</span></span><span style=display:flex><span>        address <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;ip&gt;/&lt;cidr&gt;&#34;</span>
</span></span><span style=display:flex><span>        gateway <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;&lt;ip&gt;&#34;</span>
</span></span><span style=display:flex><span>      }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    user_data_file_id <span style=color:#f92672>=</span> <span style=color:#66d9ef>proxmox_virtual_environment_file</span>.<span style=color:#66d9ef>example</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>ubuntu</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>cloud</span><span style=color:#960050;background-color:#1e0010>-</span><span style=color:#66d9ef>config</span>.<span style=color:#66d9ef>id</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>disk</span> {
</span></span><span style=display:flex><span>    datastore_id <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;local-lvm&#34;</span>
</span></span><span style=display:flex><span>    file_id      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;local:iso/&lt;iso_image_name&gt;.img&#34;</span><span style=color:#75715e> # Convertir l&#39;image au format img si n√©cessaire
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>    interface    <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;virtio0&#34;</span>
</span></span><span style=display:flex><span>    iothread     <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;true&#34;</span>
</span></span><span style=display:flex><span>    discard      <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;on&#34;</span>
</span></span><span style=display:flex><span>    size         <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;30&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>network_device</span> {
</span></span><span style=display:flex><span>    bridge <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;vmbr0&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Le d√©ploiement de cette VM s&rsquo;effectue de la m√™me mani√®re que pr√©c√©demment en suivant les √©tapes de <strong>plan</strong> et <strong>apply</strong>. Apr√®s quelques instants, une nouvelle machine virtuelle sera d√©ploy√©e avec l&rsquo;ensemble des configurations correspondant √† celles d√©finies dans le bloc d√©di√© √† <code>Cloud Init</code>. De nombreuses autres directives sont d&rsquo;ailleurs disponibles pour pousser la personnalisation.</p><h3 id=zoom-sur-cloud-init>Zoom sur Cloud Init<a hidden class=anchor aria-hidden=true href=#zoom-sur-cloud-init>#</a></h3><p><code>Cloud Init</code> propose un grand nombre de directives pour personnaliser diff√©rents aspects des d√©ploiements.</p><h4 id=paquets>Paquets<a hidden class=anchor aria-hidden=true href=#paquets>#</a></h4><p>Parfait üëç Tu peux faire une section <strong>‚ÄúZoom sur Cloud-Init‚Äù</strong> bien d√©coup√©e par th√©matique. Voici une version pr√™te √† int√©grer dans ton article, avec des exemples r√©alistes et comment√©s :</p><hr><h3 id=zoom-sur-cloud-init-1>Zoom sur Cloud-Init<a hidden class=anchor aria-hidden=true href=#zoom-sur-cloud-init-1>#</a></h3><p><code>Cloud-Init</code> propose un grand nombre de directives pour personnaliser diff√©rents aspects des d√©ploiements. L&rsquo;ensemble des directive est d√©taill√©e dans la <a href=https://cloudinit.readthedocs.io/en/latest/reference/index.html>documentation de Cloud Init</a>.</p><h4 id=paquets-1>Paquets<a hidden class=anchor aria-hidden=true href=#paquets-1>#</a></h4><p>Installer automatiquement des paquets au premier boot :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e>#cloud-config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>packages</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>vim</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>htop</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>curl</span>
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>git</span>
</span></span></code></pre></div><p>L&rsquo;installation des <code>guest-agents</code> est d&rsquo;ailleurs fortement recommand√©e sur vos VMs :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e>#cloud-config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>packages</span>:
</span></span><span style=display:flex><span>   - <span style=color:#ae81ff>qemu-guest-agent</span>
</span></span><span style=display:flex><span><span style=color:#f92672>runcmd</span>:
</span></span><span style=display:flex><span>   - <span style=color:#ae81ff>systemctl enable qemu-guest-agent</span>
</span></span><span style=display:flex><span>   - <span style=color:#ae81ff>systemctl start qemu-guest-agent</span>
</span></span></code></pre></div><h4 id=r√©seau>R√©seau<a hidden class=anchor aria-hidden=true href=#r√©seau>#</a></h4><p>Configurer une interface r√©seau avec une IP statique :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e>#cloud-config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>network</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>version</span>: <span style=color:#ae81ff>2</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>ethernets</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>ens18</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>dhcp4</span>: <span style=color:#66d9ef>no</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>addresses</span>:
</span></span><span style=display:flex><span>        - <span style=color:#ae81ff>192.168.1.50</span><span style=color:#ae81ff>/24</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>gateway4</span>: <span style=color:#ae81ff>192.168.1.1</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>nameservers</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>addresses</span>: [<span style=color:#ae81ff>192.168.1.1</span>, <span style=color:#ae81ff>8.8.8.8</span>]
</span></span></code></pre></div><p>Configurer les <code>dns</code>via <code>resolv.conf</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e>#cloud-config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>manage_resolv_conf</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>resolv_conf</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>domain</span>: <span style=color:#ae81ff>example.com</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>nameservers</span>: [<span style=color:#ae81ff>8.8.8.8</span>, <span style=color:#ae81ff>8.8.4.4</span>]
</span></span><span style=display:flex><span>  <span style=color:#f92672>options</span>: {<span style=color:#f92672>rotate: true, timeout</span>: <span style=color:#ae81ff>1</span>}
</span></span><span style=display:flex><span>  <span style=color:#f92672>searchdomains</span>: [<span style=color:#ae81ff>foo.example.com, bar.example.com]</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>sortlist</span>: [<span style=color:#ae81ff>10.0.0.1</span><span style=color:#ae81ff>/255, 10.0.0.2]</span>
</span></span></code></pre></div><h4 id=utilisateurs>Utilisateurs<a hidden class=anchor aria-hidden=true href=#utilisateurs>#</a></h4><p>D√©finir des utilisateurs suppl√©mentaires avec sudo et cl√©s SSH :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e>#cloud-config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>users</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>username</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>groups</span>: <span style=color:#ae81ff>sudo</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>shell</span>: <span style=color:#ae81ff>/bin/bash</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>sudo</span>: <span style=color:#ae81ff>ALL=(ALL) NOPASSWD:ALL</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ssh_authorized_keys</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>&lt;ssh_pub_key&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>plain_text_passwd</span>: <span style=color:#ae81ff>&lt;password&gt;</span>
</span></span></code></pre></div><h4 id=commandes-√†-linitialisation>Commandes √† l‚Äôinitialisation<a hidden class=anchor aria-hidden=true href=#commandes-√†-linitialisation>#</a></h4><p>Lancer des commandes apr√®s le boot :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e>#cloud-config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>runcmd</span>:
</span></span><span style=display:flex><span>  - <span style=color:#ae81ff>echo &#34;Server Initialised&#34; &gt; init.log</span>
</span></span></code></pre></div><hr><h4 id=gestion-des-mots-de-passe>Gestion des mots de passe<a hidden class=anchor aria-hidden=true href=#gestion-des-mots-de-passe>#</a></h4><p>D√©finir un mot de passe pour un utilisateur et activer l‚Äôauthentification SSH par mot de passe (optionnel) :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e>#cloud-config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>chpasswd</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>list</span>: |<span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    username:motdepasse</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>expire</span>: <span style=color:#66d9ef>False</span>
</span></span><span style=display:flex><span><span style=color:#f92672>ssh_pwauth</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><h4 id=mise-√†-jour-et-upgrade-syst√®me>Mise √† jour et upgrade syst√®me<a hidden class=anchor aria-hidden=true href=#mise-√†-jour-et-upgrade-syst√®me>#</a></h4><p>Forcer la mise √† jour du syst√®me lors du premier boot :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#75715e>#cloud-config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package_update</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package_upgrade</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><h2 id=standardisation-des-d√©ploiement-via-un-module-d√©di√©>Standardisation des d√©ploiement via un module d√©di√©<a hidden class=anchor aria-hidden=true href=#standardisation-des-d√©ploiement-via-un-module-d√©di√©>#</a></h2><p>L&rsquo;utilisation de <code>Terraform</code> pour d√©ployer des machines virtuelles dans <code>Proxmox</code> m&rsquo;a apport√© fluidit√© et facilit√© d&rsquo;utilisation lors de la mise en place de nouveaux services dans mon Homelab. Cependant, si dans un premier temps j&rsquo;effectuais une copie de mes configurations pour cr√©er un nouveau serveur, j&rsquo;ai rapidement pr√©f√©r√© cr√©er un module <code>Terraform</code> afin de standardiser mes d√©ploiements et de disposer d&rsquo;un bloc de code r√©utilisable afin d&rsquo;√©viter ces √©tapes fastidieuses.</p><p>Ce module est d&rsquo;ailleurs disponible publiquement sur <a href=https://github.com/Guigui0812/Terraform-Proxmox-Module/tree/main>github</a> afin d&rsquo;aider des personnes qui souhaiteraient d√©ployer facilement des VMs dans leur mon homelab personnel.</p><h2 id=conclusion>Conclusion<a hidden class=anchor aria-hidden=true href=#conclusion>#</a></h2><p>Cette approche permet de d√©ployer rapidement des VMs pr√™tes √† l‚Äôemploi. L‚Äô√©tape suivante, dans mon cas, a √©t√© d‚Äôint√©grer Ansible pour configurer automatiquement les services au-dessus des VMs. Cela permet de pousser l‚Äôautomatisation encore plus loin, dans une logique compl√®te d‚ÄôInfrastructure as Code.</p><h2 id=r√©f√©rences>R√©f√©rences<a hidden class=anchor aria-hidden=true href=#r√©f√©rences>#</a></h2><ul><li><a href=https://registry.terraform.io/providers/bpg/proxmox/latest/docs>Documentation de bpg/proxmox</a></li><li><a href=https://memo-linux.com/proxmox-deployer-une-machine-virtuelle-kvm-avec-cloud-init/>Proxmox : d√©ployer une machine virtuelle KVM avec cloud-init ‚Äì memo-linux.com</a></li><li><a href=https://www.bejean.eu/2023/03/24/creer-des-templates-de-vm-avec-cloud-init>Cr√©er des templates de machines virtuelles avec Cloud-Init</a></li><li><a href=https://blog.stephane-robert.info/docs/virtualiser/type1/proxmox/terraform/>Provisionner des VM avec Terraform - St√©phane Roberts</a></li><li><a href=https://spacelift.io/blog/terraform-apply>Terraform Apply - When to Run & Quick Usage Examples</a></li><li><a href=https://xieme-art.org/post/instancier-une-machine-virtuelle-debian-dans-proxmox-avec-opentofu-et-cloud-init/>Instancier une machine virtuelle Debian dans Proxmox avec OpenTofu et¬†Cloud-Init</a></li><li><a href=https://cloudinit.readthedocs.io/en/latest/index.html>cloud-init 25.1 documentation</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://guillaume-rohee.fr/>grohee</a></span> ¬∑
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>