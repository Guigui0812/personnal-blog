<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Grafana Loki : une stack complète pour la gestion des logs | grohee</title>
<meta name=keywords content><meta name=description content="Grafana Loki est un système de gestion de logs, qui permet de stocker et de rechercher des logs de manière efficace. Il est conçu pour être utilisé avec Promtail et Grafana pour une solution de monitoring complète.
Promtail est un agent qui collecte les logs et les envoie à Loki.
Grafana est un outil de visualisation de données initialement connu pour ses tableaux de bord de métriques, mais qui peut également être utilisé pour afficher des logs."><meta name=author content><link rel=canonical href=https://guillaume-rohee.fr/posts/grafana-loki/><link crossorigin=anonymous href=/assets/css/stylesheet.f49d66caae9ea0fd43f21f29e71a8d3e284517ed770f2aa86fa012953ad3c9ef.css integrity="sha256-9J1myq6eoP1D8h8p5xqNPihFF+13Dyqob6ASlTrTye8=" rel="preload stylesheet" as=style><link rel=icon href=https://guillaume-rohee.fr/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://guillaume-rohee.fr/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://guillaume-rohee.fr/favicon-32x32.png><link rel=apple-touch-icon href=https://guillaume-rohee.fr/apple-touch-icon.png><link rel=mask-icon href=https://guillaume-rohee.fr/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://guillaume-rohee.fr/posts/grafana-loki/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:url" content="https://guillaume-rohee.fr/posts/grafana-loki/"><meta property="og:site_name" content="grohee"><meta property="og:title" content="Grafana Loki : une stack complète pour la gestion des logs"><meta property="og:description" content="Grafana Loki est un système de gestion de logs, qui permet de stocker et de rechercher des logs de manière efficace. Il est conçu pour être utilisé avec Promtail et Grafana pour une solution de monitoring complète.
Promtail est un agent qui collecte les logs et les envoie à Loki.
Grafana est un outil de visualisation de données initialement connu pour ses tableaux de bord de métriques, mais qui peut également être utilisé pour afficher des logs."><meta property="og:locale" content="fr"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-11T00:00:00+01:00"><meta property="article:modified_time" content="2025-03-11T00:00:00+01:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Grafana Loki : une stack complète pour la gestion des logs"><meta name=twitter:description content="Grafana Loki est un système de gestion de logs, qui permet de stocker et de rechercher des logs de manière efficace. Il est conçu pour être utilisé avec Promtail et Grafana pour une solution de monitoring complète.
Promtail est un agent qui collecte les logs et les envoie à Loki.
Grafana est un outil de visualisation de données initialement connu pour ses tableaux de bord de métriques, mais qui peut également être utilisé pour afficher des logs."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://guillaume-rohee.fr/posts/"},{"@type":"ListItem","position":2,"name":"Grafana Loki : une stack complète pour la gestion des logs","item":"https://guillaume-rohee.fr/posts/grafana-loki/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Grafana Loki : une stack complète pour la gestion des logs","name":"Grafana Loki : une stack complète pour la gestion des logs","description":"Grafana Loki est un système de gestion de logs, qui permet de stocker et de rechercher des logs de manière efficace. Il est conçu pour être utilisé avec Promtail et Grafana pour une solution de monitoring complète.\nPromtail est un agent qui collecte les logs et les envoie à Loki.\nGrafana est un outil de visualisation de données initialement connu pour ses tableaux de bord de métriques, mais qui peut également être utilisé pour afficher des logs.\n","keywords":[],"articleBody":"Grafana Loki est un système de gestion de logs, qui permet de stocker et de rechercher des logs de manière efficace. Il est conçu pour être utilisé avec Promtail et Grafana pour une solution de monitoring complète.\nPromtail est un agent qui collecte les logs et les envoie à Loki.\nGrafana est un outil de visualisation de données initialement connu pour ses tableaux de bord de métriques, mais qui peut également être utilisé pour afficher des logs.\nL’ensemble des configurations détaillées ont été automatisées via des rôles Ansible stockés dans ces dépôts :\nGitHub - Guigui0812/ansible-promtail GitHub - Guigui0812/ansible-loki GitHub - Guigui0812/grafana-ansible Loki - Installation et configuration On peut installer Loki de différentes manières, mais la plus simple est d’utiliser docker-compose :\nservices: loki: user: : image: grafana/loki:latest ports: - \"3100:3100\" volumes: - ./loki-local-config.yaml:/etc/loki/local-config.yaml - /var/loki:/data command: -config.file=/etc/loki/local-config.yaml networks: - loki_network Explications :\nuser : permet de spécifier un utilisateur pour le conteneur, pour des raisons de sécurité afin de ne exécuter le conteneur en tant que root, ce qui constitue une faille de sécurité. image : utilisant l’image de la dernière version de Loki. ports : par défaut, Loki écoute sur le port 3100. volumes : monte le fichier de configuration local de Loki et le répertoire de stockage des données (pour la persistance en cas de redémarrage ou de suppression du conteneur). command : exécute Loki avec le fichier de configuration local. networks : permet de spécifier un réseau pour le conteneur (optionnel si on veut utiliser le nom du conteneur pour la communication entre les conteneurs du même hôte). Remarque : l’utilisateur loki dédié doit avoir les permissions nécessaires pour accéder aux fichiers et répertoires montés.\nLe fichier loki-local-config.yaml va contenir la configuration de Loki. Dans le cadre de mon homelab, j’utilise la configuration suivante :\nauth_enabled: false server: http_listen_port: 3100 common: ring: instance_addr: 127.0.0.1 kvstore: store: inmemory replication_factor: 1 path_prefix: /tmp/loki schema_config: configs: - from: 2025-02-26 store: tsdb object_store: filesystem schema: v13 index: prefix: index_ period: 24h storage_config: filesystem: directory: /tmp/loki/index limits_config: retention_period: 672h max_query_lookback: 672h compactor: working_directory: /tmp/loki/retention retention_enabled: true retention_delete_delay: 2h delete_request_store: filesystem Explications :\nauth_enabled : permet d’activer l’authentification pour Loki. server : permet de spécifier le port d’écoute pour Loki. common (configuration commune) : ring (anneau de stockage) : instance_addr : permet de spécifier l’adresse de l’instance de Loki. kvstore : permet de spécifier le type de stockage des clés-valeurs (inmemory pour un stockage en mémoire). inmemory est pratiques sur de petits déploiements, mais pour des déploiements plus importants, il est recommandé d’utiliser un stockage externe. replication_factor : permet de spécifier le facteur de réplication des données. path_prefix : permet de spécifier le préfixe des chemins pour Loki. Il doit être le même pour tous les chemins de Loki définis dans le fichier de configuration (/tmp/loki, /tmp/loki/index, /tmp/loki/retention). Dans le cas contraire, cela peut entraîner des erreurs lors du démarrage de Loki. schema_config (configuration du schéma) : configs : permet de spécifier la configuration du schéma. from : permet de spécifier la date à partir de laquelle le schéma est utilisé. store : permet de spécifier le type de stockage (tsdb pour un stockage en base de données de séries temporelles). object_store : permet de spécifier le type de stockage des objets (filesystem pour un stockage sur le système de fichiers). Il est possible d’utiliser d’autres types de stockage comme GCS ou S3. schema : permet de spécifier la version du schéma. index : permet de spécifier la configuration de l’index. prefix : permet de spécifier le préfixe de l’index. period : permet de spécifier la période de l’index. storage_config (configuration du stockage) : filesystem : permet de spécifier le répertoire de stockage des données. limits_config (configuration des limites) : retention_period : permet de spécifier la période de rétention des données. Après cette période, les données sont supprimées. Cela permet de gérer l’espace disque utilisé par Loki et de ne pas conserver indéfiniment les données. max_query_lookback : permet de spécifier la période maximale de recherche. Cela permet de limiter la recherche à une période donnée afin de ne pas surcharger le système. compactor (compacteur qui supprime les données après que la période de rétention soit dépassée) : working_directory : permet de spécifier le répertoire de travail du compacteur. retention_enabled : permet d’activer la rétention des données. retention_delete_delay : permet de spécifier le délai de suppression des données après la rétention. delete_request_store : permet de spécifier le type de stockage des demandes de suppression. Une fois Loki configuré, on peut le démarrer avec docker-compose :\ndocker-compose up -d Loki est ainsi prêt à recevoir des logs en provenance de promtail.\nLa documentation de Loki détaille les différentes configurations possibles : Grafana Loki configuration parameters | Grafana Loki documentation\nConfiguration avancée Ajout du plugin docker à Loki Pour que Loki soit en capacité de récupérer les logs des conteneurs docker, il est nécessaire d’ajouter le plugin docker à Loki.\nL’ajout se fait via la commande suivante :\ndocker plugin install grafana/loki-docker-driver:3.3.2-arm64 --alias loki --grant-all-permissions Plus d’informations dans la documentation de Loki : Docker Driver | Grafana Loki documentation\nBonnes pratiques La documentation de Loki liste quelques bonnes pratiques : Configuration best practices | Grafana Loki documentation\nAuthentification A venir\nStockage et rétention des logs Afin d’éviter une saturation de l’espace disque, il est important de configurer la rétention des logs via limits_config dans le fichier de configuration de Loki. Suppression des logs après la période de rétention configurée dans limits_config via le compactor. Possibilité de configurer un délai de suppression après la période de rétention pour éviter une suppression prématurée des logs. Dans le cas de la production, il est recommandé d’utiliser un stockage externe pour les logs pour des questions de redondance et de performance : GCS, S3, Minio. Le ring de Loki permet de stocker les logs en mémoire. Il est recommandé d’utiliser un stockage externe pour les données persistantes : consul, etcd, etc. Promtail Installation On peut installer promtail de différentes manières :\nDocker : en utilisant l’image officielle de promtail. Binaire : en téléchargeant le binaire de promtail et en l’exécutant directement. Source : en compilant les sources de promtail et en l’exécutant directement. La méthode la plus propre est d’installer promtail en tant qu’agent sur la machine à surveiller via le gestionnaire de paquets de la distribution. Cela permet d’enlever une couche de complexité, notamment concernant les permissions d’accès aux logs ou des configurations supplémentaires pour la récupération des logs de conteneurs.\nInstallation de promtail sur Debian :\nsudo apt install promtail Installation avec docker compose :\nservices: promtail: user: : group_add : - image: grafana/promtail:latest volumes: - /var/log:/var/log - ./config.yaml:/etc/promtail/config.yaml command: -config.file=/etc/promtail/config.yaml Explications :\nuser : permet de spécifier un utilisateur pour le conteneur, pour des raisons de sécurité afin de ne exécuter le conteneur en tant que root, ce qui constitue une faille de sécurité. group_add : permet d’ajouter le groupe de lecture des logs dans le conteneur pour que promtail puisse lire les logs (montés dans le conteneur via le volume /var/log). volume : monte les logs de la machine hôte dans le conteneur pour que promtail puisse les lire. /var/log : monte les logs de la machine hôte dans le conteneur. ./config.yaml : monte le fichier de configuration local de promtail. Remarque : les id de l’utilisateur et du groupe doivent correspondre à ceux de l’utilisateur et du groupe sur la machine hôte pour que promtail puisse lire les logs.\nConfiguration La configuration de promtail se fait via un fichier de configuration config.yaml. Ce fichier contient la configuration de promtail pour la récupération des logs et l’envoi à Loki.\nDans le cadre de mon homelab, j’utilise la configuration suivante :\nserver: http_listen_port: 9080 grpc_listen_port: 0 positions: filename: /tmp/positions.yaml clients: - url: scrape_configs: - job_name: syslog static_configs: - targets: - \"localhost\" labels: job: syslog host: __path__: /var/log/syslog - job_name: system static_configs: - targets: - \"localhost\" labels: job: system host: __path__: /var/log/auth.log - job_name: lastlog static_configs: - targets: - \"localhost\" labels: job: lastlog host: __path__: /var/log/lastlog - job_name: containers docker_sd_configs: - host: unix:///var/run/docker.sock refresh_interval: 5s relabel_configs: - source_labels: ['__meta_docker_container_name'] regex: '/(.*)' target_label: 'container' Explications :\nserver : permet de spécifier le port d’écoute pour promtail (par défaut, promtail écoute sur le port 9080). positions : permet de spécifier le fichier de position pour promtail. Ce fichier contient les positions des logs lus par promtail pour ne pas les relire à chaque redémarrage. clients : permet de spécifier les clients de promtail (dans ce cas, Loki). url : permet de spécifier l’URL de Loki. scrape_configs : permet de spécifier les configurations de récupération des logs. Dans cet exemple, on récupère les logs syslog, auth.log et lastlog de la machine locale, ainsi que les logs des conteneurs docker.\nRécupération des logs système Dans config.yaml on va pouvoir spécifier différents jobs scrape_configs pour récupérer les logs de différents services ou fichiers de logs.\nDans le cas de fichiers de logs classiques, on utilise static_configs pour spécifier les cibles à surveiller :\n... scrape_configs: - job_name: syslog static_configs: - targets: - \"localhost\" labels: job: syslog host: __path__: /var/log/syslog Explications :\njob_name : permet de spécifier le nom du job. static_configs (type de job) : targets : permet de spécifier les cibles à surveiller (dans ce cas, localhost). labels : job (obligatoire): permet de spécifier le job pour les logs. host (label personnalisé) : permet de spécifier le nom de l’hôte pour les logs. __path__ (obligatoire) : permet de spécifier le chemin du fichier de logs à surveiller. Plus d’informations sur static_configs : Configure Promtail | Grafana Loki documentation\nRécupération des logs des conteneurs Afin de récupérer les logs des conteneurs docker, on utilise docker_sd_configs.\nCette partie possède cependant des prérequis :\ndocker doit être configuré pour utiliser le driver de logs json-file ou journald. Le plugin docker doit être ajouté à Loki. Cette configuration se fait dans le fichier /etc/docker/daemon.json :\n{ \"log-driver\": \"json-file\", \"log-opts\": { \"max-size\": \"10m\", \"max-file\": \"3\" } } Plus d’informations sur la configuration des drivers de logs docker : JSON File logging driver | Docker Docs\nExemple de configuration pour récupérer les logs des conteneurs docker :\n... scrape_configs: - job_name: containers docker_sd_configs: - host: unix:///var/run/docker.sock refresh_interval: 5s relabel_configs: - source_labels: ['__meta_docker_container_name'] regex: '/(.*)' target_label: 'container' Explications :\njob_name : permet de spécifier le nom du job. docker_sd_configs (type de job) : host : permet de spécifier l’URL du socket docker afin que promtail puisse récupérer les logs des conteneurs. refresh_interval : permet de spécifier l’intervalle de rafraîchissement pour la récupération des logs. relabel_configs : permet de spécifier les configurations de relabeling des logs. source_labels : permet de spécifier les labels sources pour le relabeling. regex : permet de spécifier une expression régulière pour extraire le nom du conteneur. target_label : permet de spécifier le label cible pour le relabeling. Important : l’utilisateur promtail doit être membre du groupe docker afin d’accéder à la socket docker.\nPlus d’informations sur docker_sd_configs : Configure Promtail | Grafana Loki documentation\nRemarque : il est possible de récupérer les logs via static_configs en récupérant les logs des conteneurs docker se trouvant dans /var/lib/docker/containers.\nExemple avec static_configs :\n... scrape_configs: - job_name: containers static_configs: - targets: - \"localhost\" labels: job: containers host: __path__: /var/lib/docker/containers/*/*.log Visualisation des logs avec Grafana Une fois Loki et promtail configurés, on peut visualiser les logs avec Grafana. Pour cela on doit ajouter Loki comme source de données dans Grafana via les datasources. Ensuite, il va être possible de créer un dashboard pour visualiser les logs.\nA l’instar de Prometheus, Loki utilise un langage de requête LogQL pour interroger les logs. LogQL est similaire à PromQL mais adapté pour les logs.\nSyntaxe de LogQL LogQL permet de rechercher des logs en utilisant des expressions de requête. Voici quelques exemples de requêtes LogQL :\nRechercher des logs contenant un texte spécifique : {job=\"syslog\"} |= \"texte\" Rechercher des logs contenant plusieurs textes : {job=\"syslog\"} |= \"texte1\" | \"texte2\" Filtrer sur des labels : {job=\"syslog\"} # Un seul label {job=\"syslog\", host=\"hostname\"} # Plusieurs labels Compter le nombre de logs : count_over_time({job=\"syslog\"} |=\"texte\" [5m]) A venir Plus d’exemples de requêtes LogQL. Sécurisation de Loki et Promtail via l’authentification. Plus de détails sur la configuration du stockage et de la rétention des logs. Références Grafana Loki | Grafana Loki documentation Grafana Loki - Stéphane Robert Implementing the logging stack using Promtail, Loki, and Grafana using Docker-Compose. | by NetOpsChic | Medium Monitoring Docker Containers with Grafana, Loki, and Promtail | by Abhiraj Thakur | Medium Enabling Log Retention in Loki with Compactor | by Aditya Hilman | Medium ","wordCount":"2092","inLanguage":"en","datePublished":"2025-03-11T00:00:00+01:00","dateModified":"2025-03-11T00:00:00+01:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://guillaume-rohee.fr/posts/grafana-loki/"},"publisher":{"@type":"Organization","name":"grohee","logo":{"@type":"ImageObject","url":"https://guillaume-rohee.fr/favicon.ico"}}}</script></head><body class=dark id=top><script>localStorage.getItem("pref-theme")==="light"&&document.body.classList.remove("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://guillaume-rohee.fr/ accesskey=h title="grohee (Alt + H)">grohee</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)" aria-label="Toggle theme"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://guillaume-rohee.fr/categories/ title=Catégories><span>Catégories</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://guillaume-rohee.fr/>Home</a>&nbsp;»&nbsp;<a href=https://guillaume-rohee.fr/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Grafana Loki : une stack complète pour la gestion des logs</h1><div class=post-meta><span title='2025-03-11 00:00:00 +0100 CET'>March 11, 2025</span>&nbsp;·&nbsp;2092 words</div></header><div class=post-content><p><strong>Grafana Loki</strong> est un système de gestion de logs, qui permet de stocker et de rechercher des logs de manière efficace. Il est conçu pour être utilisé avec <strong>Promtail</strong> et <strong>Grafana</strong> pour une solution de monitoring complète.</p><p><strong>Promtail</strong> est un agent qui collecte les logs et les envoie à <strong>Loki</strong>.</p><p><strong>Grafana</strong> est un outil de visualisation de données initialement connu pour ses tableaux de bord de métriques, mais qui peut également être utilisé pour afficher des logs.</p><p>L&rsquo;ensemble des configurations détaillées ont été automatisées via des rôles <strong>Ansible</strong> stockés dans ces dépôts :</p><ul><li><a href=https://github.com/Guigui0812/ansible-promtail>GitHub - Guigui0812/ansible-promtail</a></li><li><a href=https://github.com/Guigui0812/ansible-loki>GitHub - Guigui0812/ansible-loki</a></li><li><a href=https://github.com/Guigui0812/grafana-ansible>GitHub - Guigui0812/grafana-ansible</a></li></ul><h2 id=loki---installation-et-configuration>Loki - Installation et configuration<a hidden class=anchor aria-hidden=true href=#loki---installation-et-configuration>#</a></h2><p>On peut installer <strong>Loki</strong> de différentes manières, mais la plus simple est d&rsquo;utiliser <strong>docker-compose</strong> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>loki</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>user</span>: <span style=color:#ae81ff>&lt;loki_user&gt;:&lt;loki_user&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>grafana/loki:latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;3100:3100&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./loki-local-config.yaml:/etc/loki/local-config.yaml</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/var/loki:/data</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: -<span style=color:#ae81ff>config.file=/etc/loki/local-config.yaml</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>loki_network</span>
</span></span></code></pre></div><p><strong>Explications</strong> :</p><ul><li><code>user</code> : permet de spécifier un utilisateur pour le conteneur, pour des raisons de sécurité afin de ne exécuter le conteneur en tant que <strong>root</strong>, ce qui constitue une faille de sécurité.</li><li><code>image</code> : utilisant l&rsquo;image de la dernière version de <strong>Loki</strong>.</li><li><code>ports</code> : par défaut, <strong>Loki</strong> écoute sur le port <strong>3100</strong>.</li><li><code>volumes</code> : monte le fichier de configuration local de <strong>Loki</strong> et le répertoire de stockage des données (pour la persistance en cas de redémarrage ou de suppression du conteneur).</li><li><code>command</code> : exécute <strong>Loki</strong> avec le fichier de configuration local.</li><li><code>networks</code> : permet de spécifier un réseau pour le conteneur (optionnel si on veut utiliser le nom du conteneur pour la communication entre les conteneurs du même hôte).</li></ul><p><strong>Remarque</strong> : l&rsquo;utilisateur <code>loki</code> dédié doit avoir les permissions nécessaires pour accéder aux fichiers et répertoires montés.</p><p>Le fichier <code>loki-local-config.yaml</code> va contenir la configuration de <strong>Loki</strong>. Dans le cadre de mon <strong>homelab</strong>, j&rsquo;utilise la configuration suivante :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>auth_enabled</span>: <span style=color:#66d9ef>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>http_listen_port</span>: <span style=color:#ae81ff>3100</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>common</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>ring</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>instance_addr</span>: <span style=color:#ae81ff>127.0.0.1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>kvstore</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>store</span>: <span style=color:#ae81ff>inmemory</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>replication_factor</span>: <span style=color:#ae81ff>1</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>path_prefix</span>: <span style=color:#ae81ff>/tmp/loki</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>schema_config</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>configs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>from</span>: <span style=color:#e6db74>2025-02-26</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>store</span>: <span style=color:#ae81ff>tsdb</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>object_store</span>: <span style=color:#ae81ff>filesystem</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>schema</span>: <span style=color:#ae81ff>v13</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>index</span>:
</span></span><span style=display:flex><span>      <span style=color:#f92672>prefix</span>: <span style=color:#ae81ff>index_</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>period</span>: <span style=color:#ae81ff>24h</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>storage_config</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>filesystem</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>directory</span>: <span style=color:#ae81ff>/tmp/loki/index</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>limits_config</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>retention_period</span>: <span style=color:#ae81ff>672h</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>max_query_lookback</span>: <span style=color:#ae81ff>672h</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>compactor</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>working_directory</span>: <span style=color:#ae81ff>/tmp/loki/retention</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>retention_enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>retention_delete_delay</span>: <span style=color:#ae81ff>2h</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>delete_request_store</span>: <span style=color:#ae81ff>filesystem</span>
</span></span></code></pre></div><p><strong>Explications</strong> :</p><ul><li><code>auth_enabled</code> : permet d&rsquo;activer l&rsquo;authentification pour <strong>Loki</strong>.</li><li><code>server</code> : permet de spécifier le port d&rsquo;écoute pour <strong>Loki</strong>.</li><li><code>common</code> (configuration commune) :<ul><li><code>ring</code> (anneau de stockage) :<ul><li><code>instance_addr</code> : permet de spécifier l&rsquo;adresse de l&rsquo;instance de <strong>Loki</strong>.</li><li><code>kvstore</code> : permet de spécifier le type de stockage des clés-valeurs (inmemory pour un stockage en mémoire). <strong>inmemory</strong> est pratiques sur de petits déploiements, mais pour des déploiements plus importants, il est recommandé d&rsquo;utiliser un stockage externe.</li></ul></li><li><code>replication_factor</code> : permet de spécifier le facteur de réplication des données.</li><li><code>path_prefix</code> : permet de spécifier le préfixe des chemins pour <strong>Loki</strong>. Il doit être le même pour tous les chemins de <strong>Loki</strong> définis dans le fichier de configuration (<code>/tmp/loki</code>, <code>/tmp/loki/index</code>, <code>/tmp/loki/retention</code>). Dans le cas contraire, cela peut entraîner des erreurs lors du démarrage de <strong>Loki</strong>.</li></ul></li><li><code>schema_config</code> (configuration du schéma) :<ul><li><code>configs</code> : permet de spécifier la configuration du schéma.<ul><li><code>from</code> : permet de spécifier la date à partir de laquelle le schéma est utilisé.</li><li><code>store</code> : permet de spécifier le type de stockage (tsdb pour un stockage en base de données de séries temporelles).</li><li><code>object_store</code> : permet de spécifier le type de stockage des objets (filesystem pour un stockage sur le système de fichiers). Il est possible d&rsquo;utiliser d&rsquo;autres types de stockage comme <strong>GCS</strong> ou <strong>S3</strong>.</li><li><code>schema</code> : permet de spécifier la version du schéma.</li><li><code>index</code> : permet de spécifier la configuration de l&rsquo;index.<ul><li><code>prefix</code> : permet de spécifier le préfixe de l&rsquo;index.</li><li><code>period</code> : permet de spécifier la période de l&rsquo;index.</li></ul></li></ul></li></ul></li><li><code>storage_config</code> (configuration du stockage) :<ul><li><code>filesystem</code> : permet de spécifier le répertoire de stockage des données.</li></ul></li><li><code>limits_config</code> (configuration des limites) :<ul><li><code>retention_period</code> : permet de spécifier la période de rétention des données. Après cette période, les données sont supprimées. Cela permet de gérer l&rsquo;espace disque utilisé par <strong>Loki</strong> et de ne pas conserver indéfiniment les données.</li><li><code>max_query_lookback</code> : permet de spécifier la période maximale de recherche. Cela permet de limiter la recherche à une période donnée afin de ne pas surcharger le système.</li></ul></li><li><code>compactor</code> (compacteur qui supprime les données après que la période de rétention soit dépassée) :<ul><li><code>working_directory</code> : permet de spécifier le répertoire de travail du compacteur.</li><li><code>retention_enabled</code> : permet d&rsquo;activer la rétention des données.</li><li><code>retention_delete_delay</code> : permet de spécifier le délai de suppression des données après la rétention.</li><li><code>delete_request_store</code> : permet de spécifier le type de stockage des demandes de suppression.</li></ul></li></ul><p>Une fois <strong>Loki</strong> configuré, on peut le démarrer avec <strong>docker-compose</strong> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker-compose up -d
</span></span></code></pre></div><p><strong>Loki</strong> est ainsi prêt à recevoir des logs en provenance de <strong>promtail</strong>.</p><p>La documentation de <strong>Loki</strong> détaille les différentes configurations possibles : <a href=https://grafana.com/docs/loki/latest/configure/>Grafana Loki configuration parameters | Grafana Loki documentation</a></p><h3 id=configuration-avancée>Configuration avancée<a hidden class=anchor aria-hidden=true href=#configuration-avancée>#</a></h3><h4 id=ajout-du-plugin-docker-à-loki>Ajout du plugin <strong>docker</strong> à <strong>Loki</strong><a hidden class=anchor aria-hidden=true href=#ajout-du-plugin-docker-à-loki>#</a></h4><p>Pour que <strong>Loki</strong> soit en capacité de récupérer les logs des conteneurs <strong>docker</strong>, il est nécessaire d&rsquo;ajouter le plugin <strong>docker</strong> à <strong>Loki</strong>.</p><p>L&rsquo;ajout se fait via la commande suivante :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker plugin install grafana/loki-docker-driver:3.3.2-arm64 --alias loki --grant-all-permissions
</span></span></code></pre></div><p>Plus d&rsquo;informations dans la documentation de <strong>Loki</strong> : <a href=https://grafana.com/docs/loki/latest/send-data/docker-driver/>Docker Driver | Grafana Loki documentation</a></p><h3 id=bonnes-pratiques>Bonnes pratiques<a hidden class=anchor aria-hidden=true href=#bonnes-pratiques>#</a></h3><p>La documentation de <strong>Loki</strong> liste quelques bonnes pratiques : <a href=https://grafana.com/docs/loki/latest/configure/bp-configure/>Configuration best practices | Grafana Loki documentation</a></p><h4 id=authentification>Authentification<a hidden class=anchor aria-hidden=true href=#authentification>#</a></h4><p><em>A venir</em></p><h4 id=stockage-et-rétention-des-logs>Stockage et rétention des logs<a hidden class=anchor aria-hidden=true href=#stockage-et-rétention-des-logs>#</a></h4><ul><li>Afin d&rsquo;éviter une saturation de l&rsquo;espace disque, il est important de configurer la rétention des logs via <code>limits_config</code> dans le fichier de configuration de <strong>Loki</strong>.</li><li>Suppression des logs après la période de rétention configurée dans <code>limits_config</code> via le <code>compactor</code>. Possibilité de configurer un délai de suppression après la période de rétention pour éviter une suppression prématurée des logs.</li><li>Dans le cas de la production, il est recommandé d&rsquo;utiliser un stockage externe pour les logs pour des questions de redondance et de performance : <strong>GCS</strong>, <strong>S3</strong>, <strong>Minio</strong>.</li><li>Le <strong>ring</strong> de <strong>Loki</strong> permet de stocker les logs en mémoire. Il est recommandé d&rsquo;utiliser un stockage externe pour les données persistantes : <strong>consul</strong>, <strong>etcd</strong>, etc.</li></ul><h2 id=promtail>Promtail<a hidden class=anchor aria-hidden=true href=#promtail>#</a></h2><h3 id=installation>Installation<a hidden class=anchor aria-hidden=true href=#installation>#</a></h3><p>On peut installer <strong>promtail</strong> de différentes manières :</p><ul><li><strong>Docker</strong> : en utilisant l&rsquo;image officielle de <strong>promtail</strong>.</li><li><strong>Binaire</strong> : en téléchargeant le binaire de <strong>promtail</strong> et en l&rsquo;exécutant directement.</li><li><strong>Source</strong> : en compilant les sources de <strong>promtail</strong> et en l&rsquo;exécutant directement.</li></ul><p>La méthode la plus propre est d&rsquo;installer <strong>promtail</strong> en tant qu&rsquo;agent sur la machine à surveiller via le gestionnaire de paquets de la distribution. Cela permet d&rsquo;enlever une couche de complexité, notamment concernant les permissions d&rsquo;accès aux logs ou des configurations supplémentaires pour la récupération des logs de conteneurs.</p><p>Installation de <strong>promtail</strong> sur <strong>Debian</strong> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install promtail
</span></span></code></pre></div><p>Installation avec <code>docker compose</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>promtail</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>user</span>: <span style=color:#ae81ff>&lt;promtail_user&gt;:&lt;promtail_user&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>group_add </span>: 
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>&lt;log_reader_group&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>grafana/promtail:latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/var/log:/var/log</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>./config.yaml:/etc/promtail/config.yaml</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>command</span>: -<span style=color:#ae81ff>config.file=/etc/promtail/config.yaml</span>
</span></span></code></pre></div><p><strong>Explications</strong> :</p><ul><li><code>user</code> : permet de spécifier un utilisateur pour le conteneur, pour des raisons de sécurité afin de ne exécuter le conteneur en tant que <strong>root</strong>, ce qui constitue une faille de sécurité.</li><li><code>group_add</code> : permet d&rsquo;ajouter le groupe de lecture des logs dans le conteneur pour que <strong>promtail</strong> puisse lire les logs (montés dans le conteneur via le volume <code>/var/log</code>).</li><li><code>volume</code> : monte les logs de la machine hôte dans le conteneur pour que <strong>promtail</strong> puisse les lire.<ul><li><code>/var/log</code> : monte les logs de la machine hôte dans le conteneur.</li><li><code>./config.yaml</code> : monte le fichier de configuration local de <strong>promtail</strong>.</li></ul></li></ul><p><strong>Remarque</strong> : les <code>id</code> de l&rsquo;utilisateur et du groupe doivent correspondre à ceux de l&rsquo;utilisateur et du groupe sur la machine hôte pour que <strong>promtail</strong> puisse lire les logs.</p><h3 id=configuration>Configuration<a hidden class=anchor aria-hidden=true href=#configuration>#</a></h3><p>La configuration de <strong>promtail</strong> se fait via un fichier de configuration <code>config.yaml</code>. Ce fichier contient la configuration de <strong>promtail</strong> pour la récupération des logs et l&rsquo;envoi à <strong>Loki</strong>.</p><p>Dans le cadre de mon <strong>homelab</strong>, j&rsquo;utilise la configuration suivante :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>server</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>http_listen_port</span>: <span style=color:#ae81ff>9080</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>grpc_listen_port</span>: <span style=color:#ae81ff>0</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>positions</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>filename</span>: <span style=color:#ae81ff>/tmp/positions.yaml</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>clients</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>url</span>: <span style=color:#ae81ff>&lt;loki_url&gt;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>scrape_configs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>syslog</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>targets</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>job</span>: <span style=color:#ae81ff>syslog</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>&lt;hostname&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>__path__</span>: <span style=color:#ae81ff>/var/log/syslog</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>system</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>targets</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>job</span>: <span style=color:#ae81ff>system</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>&lt;hostname&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>__path__</span>: <span style=color:#ae81ff>/var/log/auth.log</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>lastlog</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>targets</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>job</span>: <span style=color:#ae81ff>lastlog</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>&lt;hostname&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>__path__</span>: <span style=color:#ae81ff>/var/log/lastlog</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>containers</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>docker_sd_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>host</span>: <span style=color:#ae81ff>unix:///var/run/docker.sock</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>refresh_interval</span>: <span style=color:#ae81ff>5s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>relabel_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>source_labels</span>: [<span style=color:#e6db74>&#39;__meta_docker_container_name&#39;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>regex</span>: <span style=color:#e6db74>&#39;/(.*)&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>target_label</span>: <span style=color:#e6db74>&#39;container&#39;</span>
</span></span></code></pre></div><p><strong>Explications</strong> :</p><ul><li><code>server</code> : permet de spécifier le port d&rsquo;écoute pour <strong>promtail</strong> (par défaut, <strong>promtail</strong> écoute sur le port <strong>9080</strong>).</li><li><code>positions</code> : permet de spécifier le fichier de position pour <strong>promtail</strong>. Ce fichier contient les positions des logs lus par <strong>promtail</strong> pour ne pas les relire à chaque redémarrage.</li><li><code>clients</code> : permet de spécifier les clients de <strong>promtail</strong> (dans ce cas, <strong>Loki</strong>).<ul><li><code>url</code> : permet de spécifier l&rsquo;URL de <strong>Loki</strong>.</li></ul></li><li><code>scrape_configs</code> : permet de spécifier les configurations de récupération des logs.</li></ul><p>Dans cet exemple, on récupère les logs <strong>syslog</strong>, <strong>auth.log</strong> et <strong>lastlog</strong> de la machine locale, ainsi que les logs des conteneurs <strong>docker</strong>.</p><h4 id=récupération-des-logs-système>Récupération des logs système<a hidden class=anchor aria-hidden=true href=#récupération-des-logs-système>#</a></h4><p>Dans <code>config.yaml</code> on va pouvoir spécifier différents jobs <code>scrape_configs</code> pour récupérer les logs de différents services ou fichiers de logs.</p><p>Dans le cas de fichiers de logs classiques, on utilise <code>static_configs</code> pour spécifier les cibles à surveiller :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#f92672>scrape_configs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>syslog</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>targets</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>job</span>: <span style=color:#ae81ff>syslog</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>&lt;hostname&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>__path__</span>: <span style=color:#ae81ff>/var/log/syslog</span>
</span></span></code></pre></div><p><strong>Explications</strong> :</p><ul><li><code>job_name</code> : permet de spécifier le nom du job.</li><li><code>static_configs</code> (type de job) :<ul><li><code>targets</code> : permet de spécifier les cibles à surveiller (dans ce cas, <code>localhost</code>).</li><li><code>labels</code> :<ul><li><code>job</code> (obligatoire): permet de spécifier le job pour les logs.</li><li><code>host</code> (label personnalisé) : permet de spécifier le nom de l&rsquo;hôte pour les logs.</li><li><code>__path__</code> (obligatoire) : permet de spécifier le chemin du fichier de logs à surveiller.</li></ul></li></ul></li></ul><p>Plus d&rsquo;informations sur <strong>static_configs</strong> : <a href=https://grafana.com/docs/loki/latest/send-data/promtail/configuration/#scrape_configs>Configure Promtail | Grafana Loki documentation</a></p><h4 id=récupération-des-logs-des-conteneurs>Récupération des logs des conteneurs<a hidden class=anchor aria-hidden=true href=#récupération-des-logs-des-conteneurs>#</a></h4><p>Afin de récupérer les logs des conteneurs <strong>docker</strong>, on utilise <code>docker_sd_configs</code>.</p><p>Cette partie possède cependant des <strong>prérequis</strong> :</p><ul><li><strong>docker</strong> doit être configuré pour utiliser le <strong>driver</strong> de logs <strong>json-file</strong> ou <strong>journald</strong>.</li><li>Le <strong>plugin</strong> <strong>docker</strong> doit être ajouté à <strong>Loki</strong>.</li></ul><p>Cette configuration se fait dans le fichier <code>/etc/docker/daemon.json</code> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;log-driver&#34;</span>: <span style=color:#e6db74>&#34;json-file&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;log-opts&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;max-size&#34;</span>: <span style=color:#e6db74>&#34;10m&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;max-file&#34;</span>: <span style=color:#e6db74>&#34;3&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Plus d&rsquo;informations sur la configuration des drivers de logs <strong>docker</strong> : <a href=https://docs.docker.com/engine/logging/drivers/json-file/>JSON File logging driver | Docker Docs</a></p><p>Exemple de configuration pour récupérer les logs des conteneurs <strong>docker</strong> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#f92672>scrape_configs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>containers</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>docker_sd_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>host</span>: <span style=color:#ae81ff>unix:///var/run/docker.sock</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>refresh_interval</span>: <span style=color:#ae81ff>5s</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>relabel_configs</span>:
</span></span><span style=display:flex><span>      - <span style=color:#f92672>source_labels</span>: [<span style=color:#e6db74>&#39;__meta_docker_container_name&#39;</span>]
</span></span><span style=display:flex><span>        <span style=color:#f92672>regex</span>: <span style=color:#e6db74>&#39;/(.*)&#39;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>target_label</span>: <span style=color:#e6db74>&#39;container&#39;</span>
</span></span></code></pre></div><p><strong>Explications</strong> :</p><ul><li><code>job_name</code> : permet de spécifier le nom du job.</li><li><code>docker_sd_configs</code> (type de job) :<ul><li><code>host</code> : permet de spécifier l&rsquo;URL du socket <strong>docker</strong> afin que <strong>promtail</strong> puisse récupérer les logs des conteneurs.</li><li><code>refresh_interval</code> : permet de spécifier l&rsquo;intervalle de rafraîchissement pour la récupération des logs.</li></ul></li><li><code>relabel_configs</code> : permet de spécifier les configurations de relabeling des logs.<ul><li><code>source_labels</code> : permet de spécifier les labels sources pour le relabeling.</li><li><code>regex</code> : permet de spécifier une expression régulière pour extraire le nom du conteneur.</li><li><code>target_label</code> : permet de spécifier le label cible pour le relabeling.</li></ul></li></ul><p><strong>Important</strong> : l&rsquo;utilisateur <strong>promtail</strong> doit être membre du groupe <strong>docker</strong> afin d&rsquo;accéder à la socket <strong>docker</strong>.</p><p>Plus d&rsquo;informations sur <strong>docker_sd_configs</strong> : <a href=https://grafana.com/docs/loki/latest/send-data/promtail/configuration/#docker_sd_configs>Configure Promtail | Grafana Loki documentation</a></p><p><strong>Remarque</strong> : il est possible de récupérer les logs via <strong>static_configs</strong> en récupérant les logs des conteneurs <strong>docker</strong> se trouvant dans <code>/var/lib/docker/containers</code>.</p><p>Exemple avec <strong>static_configs</strong> :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>...
</span></span><span style=display:flex><span><span style=color:#f92672>scrape_configs</span>:
</span></span><span style=display:flex><span>  - <span style=color:#f92672>job_name</span>: <span style=color:#ae81ff>containers</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>static_configs</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>targets</span>:
</span></span><span style=display:flex><span>        - <span style=color:#e6db74>&#34;localhost&#34;</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>job</span>: <span style=color:#ae81ff>containers</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>host</span>: <span style=color:#ae81ff>&lt;hostname&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>__path__</span>: <span style=color:#ae81ff>/var/lib/docker/containers/*/*.log</span>
</span></span></code></pre></div><h2 id=visualisation-des-logs-avec-grafana>Visualisation des logs avec Grafana<a hidden class=anchor aria-hidden=true href=#visualisation-des-logs-avec-grafana>#</a></h2><p>Une fois <strong>Loki</strong> et <strong>promtail</strong> configurés, on peut visualiser les logs avec <strong>Grafana</strong>. Pour cela on doit ajouter <strong>Loki</strong> comme source de données dans <strong>Grafana</strong> via les <strong>datasources</strong>. Ensuite, il va être possible de créer un <strong>dashboard</strong> pour visualiser les logs.</p><p>A l&rsquo;instar de <strong>Prometheus</strong>, <strong>Loki</strong> utilise un langage de requête <strong>LogQL</strong> pour interroger les logs. <strong>LogQL</strong> est similaire à <strong>PromQL</strong> mais adapté pour les logs.</p><h3 id=syntaxe-de-logql>Syntaxe de LogQL<a hidden class=anchor aria-hidden=true href=#syntaxe-de-logql>#</a></h3><p><strong>LogQL</strong> permet de rechercher des logs en utilisant des expressions de requête. Voici quelques exemples de requêtes <strong>LogQL</strong> :</p><ul><li>Rechercher des logs contenant un texte spécifique :</li></ul><pre tabindex=0><code class=language-logql data-lang=logql>{job=&#34;syslog&#34;} |= &#34;texte&#34;
</code></pre><ul><li>Rechercher des logs contenant plusieurs textes :</li></ul><pre tabindex=0><code class=language-logql data-lang=logql>{job=&#34;syslog&#34;} |= &#34;texte1&#34; | &#34;texte2&#34;
</code></pre><ul><li>Filtrer sur des labels :</li></ul><pre tabindex=0><code class=language-logql data-lang=logql>{job=&#34;syslog&#34;} # Un seul label
{job=&#34;syslog&#34;, host=&#34;hostname&#34;} # Plusieurs labels
</code></pre><ul><li>Compter le nombre de logs :</li></ul><pre tabindex=0><code class=language-logql data-lang=logql>count_over_time({job=&#34;syslog&#34;} |=&#34;texte&#34; [5m])
</code></pre><h2 id=a-venir>A venir<a hidden class=anchor aria-hidden=true href=#a-venir>#</a></h2><ul><li>Plus d&rsquo;exemples de requêtes <strong>LogQL</strong>.</li><li>Sécurisation de <strong>Loki</strong> et <strong>Promtail</strong> via l&rsquo;authentification.</li><li>Plus de détails sur la configuration du stockage et de la rétention des logs.</li></ul><h2 id=références>Références<a hidden class=anchor aria-hidden=true href=#références>#</a></h2><ul><li><a href=https://grafana.com/docs/loki/latest/>Grafana Loki | Grafana Loki documentation</a></li><li><a href=https://blog.stephane-robert.info/docs/observer/logs/loki/>Grafana Loki - Stéphane Robert</a></li><li><a href=https://medium.com/@netopschic/implementing-the-log-monitoring-stack-using-promtail-loki-and-grafana-using-docker-compose-bcb07d1a51aa>Implementing the logging stack using Promtail, Loki, and Grafana using Docker-Compose. | by NetOpsChic | Medium</a></li><li><a href=https://abhiraj2001.medium.com/monitoring-docker-containers-with-grafana-loki-and-promtail-4302a9417c0d>Monitoring Docker Containers with Grafana, Loki, and Promtail | by Abhiraj Thakur | Medium</a></li><li><a href=https://medium.com/@aditya.hilman_10961/enabling-log-retention-in-loki-with-compactor-fe3de2002b47>Enabling Log Retention in Loki with Compactor | by Aditya Hilman | Medium</a></li></ul></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://guillaume-rohee.fr/>grohee</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>